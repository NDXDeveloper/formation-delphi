# 19.1.4 Rapports et tableaux de bord

üîù Retour √† la [Table des mati√®res](/SOMMAIRE.md)

Dans cette section, nous allons apprendre √† cr√©er des rapports professionnels et des tableaux de bord interactifs pour notre application de gestion. Ces outils sont essentiels pour analyser les donn√©es, prendre des d√©cisions √©clair√©es et pr√©senter l'information de mani√®re claire aux utilisateurs.

## Pourquoi int√©grer des rapports et tableaux de bord ?

Les rapports et tableaux de bord jouent un r√¥le crucial dans toute application de gestion :

- **Visualisation des donn√©es** : transformer des chiffres bruts en graphiques faciles √† comprendre
- **Aide √† la d√©cision** : identifier les tendances, les points forts et les probl√®mes
- **Communication** : partager facilement l'information avec les parties prenantes
- **Suivi des performances** : mesurer l'activit√© par rapport aux objectifs
- **Documentation** : conserver un historique des activit√©s

## Architecture des rapports dans notre application

Nous allons impl√©menter deux approches compl√©mentaires :

1. **Rapports statiques** : documents format√©s pouvant √™tre imprim√©s ou export√©s
2. **Tableaux de bord dynamiques** : interfaces interactives permettant d'explorer les donn√©es

![Architecture des rapports](https://via.placeholder.com/800x400)

## Utilisation de FastReport pour les rapports

FastReport est l'un des outils de reporting les plus populaires pour Delphi. Dans ce tutoriel, nous utiliserons sa version Community Edition qui est gratuite.

> **Note** : Si vous n'avez pas FastReport install√©, vous pouvez l'obtenir via GetIt Package Manager dans Delphi. Allez dans Outils > GetIt Package Manager, recherchez "FastReport" et installez la version communautaire.

### Installation de FastReport VCL

1. Dans Delphi, s√©lectionnez **Outils > GetIt Package Manager**
2. Dans la barre de recherche, tapez "FastReport"
3. Trouvez "FastReport VCL Community Edition" et cliquez sur "Install"
4. Suivez les instructions d'installation
5. Red√©marrez Delphi pour terminer l'installation

### Cr√©ation d'un rapport de ventes simple

Commen√ßons par cr√©er un rapport de ventes basique :

1. Ajoutez un nouveau Data Module √† votre projet et nommez-le `dmReports`
2. Ajoutez un composant `TFDQuery` et configurez-le pour extraire les donn√©es des ventes
3. Ajoutez un composant `TfrxReport` et un `TfrxDBDataset` depuis la palette FastReport
4. Liez le `TfrxDBDataset` √† votre query

Voici le code pour configurer le module de donn√©es :

```pascal
unit dmReports;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, frxClass, frxDBSet,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, dmDatabase;

type
  TDataModuleReports = class(TDataModule)
    qrySalesReport: TFDQuery;
    frxReport1: TfrxReport;
    frxDBDataset1: TfrxDBDataset;
    procedure DataModuleCreate(Sender: TObject);
  private
    { D√©clarations priv√©es }
  public
    { D√©clarations publiques }
    procedure PrepareSalesReport(const AStartDate, AEndDate: TDateTime);
    procedure ShowSalesReport;
  end;

var
  DataModuleReports: TDataModuleReports;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

{$R *.dfm}

procedure TDataModuleReports.DataModuleCreate(Sender: TObject);
begin
  // Configurer le dataset FastReport
  frxDBDataset1.DataSet := qrySalesReport;

  // Charger le fichier de rapport s'il existe
  if FileExists(ExtractFilePath(ParamStr(0)) + 'Reports\SalesReport.fr3') then
    frxReport1.LoadFromFile(ExtractFilePath(ParamStr(0)) + 'Reports\SalesReport.fr3');
end;

procedure TDataModuleReports.PrepareSalesReport(const AStartDate, AEndDate: TDateTime);
begin
  // Configurer la requ√™te
  qrySalesReport.Close;
  qrySalesReport.SQL.Text :=
    'SELECT c.CommandeID, c.Reference, c.DateCommande, ' +
    'cl.Nom AS NomClient, cl.Prenom AS PrenomClient, ' +
    'SUM(l.Quantite * l.PrixUnitaire * (1 - l.Remise / 100)) AS MontantHT, ' +
    'c.MontantTTC, c.Statut ' +
    'FROM Commandes c ' +
    'JOIN Clients cl ON c.ClientID = cl.ClientID ' +
    'JOIN LignesCommande l ON c.CommandeID = l.CommandeID ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'GROUP BY c.CommandeID ' +
    'ORDER BY c.DateCommande DESC';

  qrySalesReport.ParamByName('DateDebut').AsDate := AStartDate;
  qrySalesReport.ParamByName('DateFin').AsDate := AEndDate;
  qrySalesReport.Open;
end;

procedure TDataModuleReports.ShowSalesReport;
begin
  // V√©rifier que les donn√©es sont disponibles
  if qrySalesReport.IsEmpty then
  begin
    ShowMessage('Aucune donn√©e disponible pour cette p√©riode.');
    Exit;
  end;

  // Afficher l'aper√ßu du rapport
  frxReport1.ShowReport;
end;

end.
```

### Conception du rapport avec l'√©diteur FastReport

Maintenant que notre module de donn√©es est configur√©, nous allons concevoir le rapport :

1. Double-cliquez sur le composant `frxReport1` pour ouvrir l'√©diteur FastReport
2. Dans l'√©diteur, allez dans le menu **Rapport > Donn√©es...**
3. V√©rifiez que votre `frxDBDataset1` est disponible
4. Cliquez sur **OK** pour retourner √† l'√©diteur
5. Ajoutez les bandes n√©cessaires : Report Title, Page Header, Master Data, Page Footer
6. Glissez-d√©posez les champs de donn√©es sur la bande Master Data
7. Ajoutez des titres, des logos et le formatage souhait√©
8. Enregistrez le rapport sous "SalesReport.fr3" dans un dossier "Reports"

![√âditeur FastReport](https://via.placeholder.com/800x600)

### Cr√©ation d'un formulaire pour g√©n√©rer les rapports

Maintenant, cr√©ons un formulaire qui permettra √† l'utilisateur de s√©lectionner la p√©riode et de g√©n√©rer le rapport :

```pascal
unit FormSalesReport;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.ComCtrls, Vcl.Buttons, dmReports;

type
  TfrmSalesReport = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlParams: TPanel;
    lblPeriod: TLabel;
    dtpStart: TDateTimePicker;
    dtpEnd: TDateTimePicker;
    lblTo: TLabel;
    pnlButtons: TPanel;
    btnGenerate: TButton;
    btnClose: TButton;
    rbCurrentMonth: TRadioButton;
    rbLastMonth: TRadioButton;
    rbCustomPeriod: TRadioButton;
    procedure FormCreate(Sender: TObject);
    procedure rbCurrentMonthClick(Sender: TObject);
    procedure rbLastMonthClick(Sender: TObject);
    procedure rbCustomPeriodClick(Sender: TObject);
    procedure btnGenerateClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { D√©clarations priv√©es }
    procedure UpdateDatePickers;
  public
    { D√©clarations publiques }
  end;

var
  frmSalesReport: TfrmSalesReport;

implementation

{$R *.dfm}

procedure TfrmSalesReport.FormCreate(Sender: TObject);
begin
  // Par d√©faut, s√©lectionner le mois courant
  rbCurrentMonth.Checked := True;
  UpdateDatePickers;
end;

procedure TfrmSalesReport.UpdateDatePickers;
var
  Y, M, D: Word;
  FirstDay, LastDay: TDateTime;
begin
  if rbCurrentMonth.Checked then
  begin
    // Mois courant
    DecodeDate(Date, Y, M, D);
    FirstDay := EncodeDate(Y, M, 1);
    LastDay := IncMonth(FirstDay, 1) - 1;

    dtpStart.Date := FirstDay;
    dtpEnd.Date := LastDay;

    dtpStart.Enabled := False;
    dtpEnd.Enabled := False;
  end
  else if rbLastMonth.Checked then
  begin
    // Mois pr√©c√©dent
    DecodeDate(IncMonth(Date, -1), Y, M, D);
    FirstDay := EncodeDate(Y, M, 1);
    LastDay := IncMonth(FirstDay, 1) - 1;

    dtpStart.Date := FirstDay;
    dtpEnd.Date := LastDay;

    dtpStart.Enabled := False;
    dtpEnd.Enabled := False;
  end
  else if rbCustomPeriod.Checked then
  begin
    // P√©riode personnalis√©e
    dtpStart.Enabled := True;
    dtpEnd.Enabled := True;
  end;
end;

procedure TfrmSalesReport.rbCurrentMonthClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.rbLastMonthClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.rbCustomPeriodClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.btnGenerateClick(Sender: TObject);
begin
  // V√©rifier les dates
  if dtpStart.Date > dtpEnd.Date then
  begin
    ShowMessage('La date de d√©but doit √™tre ant√©rieure √† la date de fin.');
    Exit;
  end;

  // Pr√©parer et afficher le rapport
  DataModuleReports.PrepareSalesReport(dtpStart.Date, dtpEnd.Date);
  DataModuleReports.ShowSalesReport;
end;

procedure TfrmSalesReport.btnCloseClick(Sender: TObject);
begin
  Close;
end;

end.
```

### Exportation des rapports dans diff√©rents formats

FastReport permet d'exporter vos rapports dans plusieurs formats tels que PDF, Excel, Word, etc. Ajoutons cette fonctionnalit√© :

```pascal
procedure TDataModuleReports.ExportSalesReportToPDF(const AFileName: string);
begin
  if qrySalesReport.IsEmpty then
  begin
    ShowMessage('Aucune donn√©e disponible pour cette p√©riode.');
    Exit;
  end;

  // Configurer l'export PDF
  if frxReport1.PrepareReport then
  begin
    // V√©rifier si le composant d'export est disponible
    if frxPDFExport1 = nil then
    begin
      frxPDFExport1 := TfrxPDFExport.Create(Self);
      frxPDFExport1.ShowDialog := False;
      frxPDFExport1.Background := True;
      frxPDFExport1.ShowProgress := False;
    end;

    // Configurer l'export
    frxPDFExport1.FileName := AFileName;
    frxPDFExport1.DefaultPath := ExtractFilePath(AFileName);

    // Exporter
    if frxReport1.Export(frxPDFExport1) then
      ShowMessage('Le rapport a √©t√© export√© avec succ√®s : ' + AFileName);
  end;
end;
```

## Cr√©ation d'un tableau de bord avec TeeChart

TeeChart est une biblioth√®que de graphiques int√©gr√©e √† Delphi. Utilisons-la pour cr√©er un tableau de bord.

> **Note** : Si vous utilisez Delphi 11 ou 12, TeeChart est d√©j√† inclus. Pour les versions ant√©rieures, vous devrez peut-√™tre l'installer s√©par√©ment.

### Cr√©ation d'un formulaire de tableau de bord

Commen√ßons par cr√©er un formulaire pour notre tableau de bord :

```pascal
unit FormDashboard;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.ComCtrls, VclTee.TeeGDIPlus, VclTee.TeEngine, VclTee.TeeProcs, VclTee.Chart,
  VclTee.Series, Data.DB, FireDAC.Comp.Client, dmDatabase;

type
  TfrmDashboard = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    cboDateRange: TComboBox;
    lblDateRange: TLabel;
    pnlMain: TPanel;
    splHorizontal: TSplitter;
    pnlTop50: TPanel;
    pnlBottom50: TPanel;
    splVertical: TSplitter;
    pnlBottomLeft: TPanel;
    pnlBottomRight: TPanel;
    chartSales: TChart;
    seriesSales: TBarSeries;
    chartTopProducts: TChart;
    seriesTopProducts: TPieSeries;
    chartCustomers: TChart;
    seriesCustomers: TLineSeries;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure cboDateRangeChange(Sender: TObject);
  private
    { D√©clarations priv√©es }
    FSalesQuery: TFDQuery;
    FTopProductsQuery: TFDQuery;
    FCustomersQuery: TFDQuery;

    procedure InitializeCharts;
    procedure LoadSalesData;
    procedure LoadTopProductsData;
    procedure LoadCustomersData;
    procedure LoadDashboardData;
  public
    { D√©clarations publiques }
  end;

var
  frmDashboard: TfrmDashboard;

implementation

{$R *.dfm}

procedure TfrmDashboard.FormCreate(Sender: TObject);
begin
  // Cr√©er les requ√™tes
  FSalesQuery := TFDQuery.Create(Self);
  FSalesQuery.Connection := DataModuleDB.FDConnection;

  FTopProductsQuery := TFDQuery.Create(Self);
  FTopProductsQuery.Connection := DataModuleDB.FDConnection;

  FCustomersQuery := TFDQuery.Create(Self);
  FCustomersQuery.Connection := DataModuleDB.FDConnection;

  // Initialiser les graphiques
  InitializeCharts;

  // Remplir la combobox des p√©riodes
  cboDateRange.Items.Clear;
  cboDateRange.Items.Add('7 derniers jours');
  cboDateRange.Items.Add('30 derniers jours');
  cboDateRange.Items.Add('Ce mois-ci');
  cboDateRange.Items.Add('Ce trimestre');
  cboDateRange.Items.Add('Cette ann√©e');
  cboDateRange.ItemIndex := 2; // Ce mois-ci par d√©faut

  // Charger les donn√©es
  LoadDashboardData;
end;

procedure TfrmDashboard.FormDestroy(Sender: TObject);
begin
  FSalesQuery.Free;
  FTopProductsQuery.Free;
  FCustomersQuery.Free;
end;

procedure TfrmDashboard.InitializeCharts;
begin
  // Configurer le graphique des ventes
  with chartSales do
  begin
    Title.Text.Clear;
    Title.Text.Add('√âvolution des ventes');
    Legend.Visible := False;
    Gradient.Visible := True;
    View3D := False;
  end;

  // Configurer le graphique des produits
  with chartTopProducts do
  begin
    Title.Text.Clear;
    Title.Text.Add('Top 5 des produits');
    Legend.Visible := True;
    Gradient.Visible := True;
    View3D := True;
  end;

  // Configurer le graphique des clients
  with chartCustomers do
  begin
    Title.Text.Clear;
    Title.Text.Add('Nouveaux clients');
    Legend.Visible := False;
    Gradient.Visible := True;
    View3D := False;
  end;
end;

procedure TfrmDashboard.LoadDashboardData;
begin
  Screen.Cursor := crHourGlass;
  try
    LoadSalesData;
    LoadTopProductsData;
    LoadCustomersData;
  finally
    Screen.Cursor := crDefault;
  end;
end;

procedure TfrmDashboard.LoadSalesData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
  DateFormat: string;
  GroupBy: string;
begin
  // D√©terminer la p√©riode
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        StartDate := Date - 6;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    1: // 30 derniers jours
      begin
        StartDate := Date - 29;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    2: // Ce mois-ci
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    3: // Ce trimestre
      begin
        StartDate := StartOfTheQuarter(Date);
        EndDate := EndOfTheQuarter(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
      end;
    4: // Cette ann√©e
      begin
        StartDate := StartOfTheYear(Date);
        EndDate := EndOfTheYear(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
      end;
    else
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
  end;

  // Construire la requ√™te SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroupe, ' +
    'DATE_FORMAT(c.DateCommande, ''%s'') AS DateAffichage, ' +
    'SUM(c.MontantTTC) AS TotalVentes ' +
    'FROM Commandes c ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annul√©e'') ' +
    'GROUP BY DateGroupe ' +
    'ORDER BY DateGroupe';

  SQL := Format(SQL, [DateFormat]);

  // Ex√©cuter la requ√™te
  FSalesQuery.Close;
  FSalesQuery.SQL.Text := SQL;
  FSalesQuery.ParamByName('DateDebut').AsDate := StartDate;
  FSalesQuery.ParamByName('DateFin').AsDate := EndDate;
  FSalesQuery.Open;

  // Effacer le graphique
  seriesSales.Clear;

  // Remplir le graphique
  while not FSalesQuery.Eof do
  begin
    seriesSales.Add(
      FSalesQuery.FieldByName('TotalVentes').AsFloat,
      FSalesQuery.FieldByName('DateAffichage').AsString
    );
    FSalesQuery.Next;
  end;
end;

procedure TfrmDashboard.LoadTopProductsData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
begin
  // D√©terminer la p√©riode
  case cboDateRange.ItemIndex of
    0: StartDate := Date - 6; // 7 derniers jours
    1: StartDate := Date - 29; // 30 derniers jours
    2: StartDate := StartOfTheMonth(Date); // Ce mois-ci
    3: StartDate := StartOfTheQuarter(Date); // Ce trimestre
    4: StartDate := StartOfTheYear(Date); // Cette ann√©e
    else StartDate := StartOfTheMonth(Date);
  end;
  EndDate := Date;

  // Construire la requ√™te SQL
  SQL :=
    'SELECT p.Designation, SUM(l.Quantite) AS TotalVendus, ' +
    'SUM(l.Quantite * l.PrixUnitaire * (1 - l.Remise / 100)) AS MontantTotal ' +
    'FROM LignesCommande l ' +
    'JOIN Produits p ON l.ProduitID = p.ProduitID ' +
    'JOIN Commandes c ON l.CommandeID = c.CommandeID ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annul√©e'') ' +
    'GROUP BY p.ProduitID ' +
    'ORDER BY TotalVendus DESC ' +
    'LIMIT 5';

  // Ex√©cuter la requ√™te
  FTopProductsQuery.Close;
  FTopProductsQuery.SQL.Text := SQL;
  FTopProductsQuery.ParamByName('DateDebut').AsDate := StartDate;
  FTopProductsQuery.ParamByName('DateFin').AsDate := EndDate;
  FTopProductsQuery.Open;

  // Effacer le graphique
  seriesTopProducts.Clear;

  // Remplir le graphique
  while not FTopProductsQuery.Eof do
  begin
    seriesTopProducts.Add(
      FTopProductsQuery.FieldByName('TotalVendus').AsFloat,
      FTopProductsQuery.FieldByName('Designation').AsString,
      clRandom
    );
    FTopProductsQuery.Next;
  end;
end;

procedure TfrmDashboard.LoadCustomersData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
  DateFormat: string;
  GroupBy: string;
begin
  // D√©terminer la p√©riode
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        StartDate := Date - 6;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    1: // 30 derniers jours
      begin
        StartDate := Date - 29;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    2: // Ce mois-ci
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    3: // Ce trimestre
      begin
        StartDate := StartOfTheQuarter(Date);
        EndDate := EndOfTheQuarter(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(DateCreation), MONTH(DateCreation)';
      end;
    4: // Cette ann√©e
      begin
        StartDate := StartOfTheYear(Date);
        EndDate := EndOfTheYear(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(DateCreation), MONTH(DateCreation)';
      end;
    else
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
  end;

  // Construire la requ√™te SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroupe, ' +
    'DATE_FORMAT(DateCreation, ''%s'') AS DateAffichage, ' +
    'COUNT(*) AS NouveauxClients ' +
    'FROM Clients ' +
    'WHERE DateCreation BETWEEN :DateDebut AND :DateFin ' +
    'GROUP BY DateGroupe ' +
    'ORDER BY DateGroupe';

  SQL := Format(SQL, [DateFormat]);

  // Ex√©cuter la requ√™te
  FCustomersQuery.Close;
  FCustomersQuery.SQL.Text := SQL;
  FCustomersQuery.ParamByName('DateDebut').AsDate := StartDate;
  FCustomersQuery.ParamByName('DateFin').AsDate := EndDate;
  FCustomersQuery.Open;

  // Effacer le graphique
  seriesCustomers.Clear;

  // Remplir le graphique
  while not FCustomersQuery.Eof do
  begin
    seriesCustomers.AddXY(
      seriesCustomers.Count + 1,
      FCustomersQuery.FieldByName('NouveauxClients').AsFloat,
      FCustomersQuery.FieldByName('DateAffichage').AsString
    );
    FCustomersQuery.Next;
  end;
end;

procedure TfrmDashboard.cboDateRangeChange(Sender: TObject);
begin
  LoadDashboardData;
end;

// Fonctions utilitaires pour les dates
function StartOfTheMonth(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, M, 1);
end;

function EndOfTheMonth(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, M, 1) + 32;
  DecodeDate(Result, Y, M, D);
  Result := EncodeDate(Y, M, 1) - 1;
end;

function StartOfTheQuarter(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
  QuarterMonth: Integer;
begin
  DecodeDate(ADate, Y, M, D);
  QuarterMonth := ((M - 1) div 3) * 3 + 1;
  Result := EncodeDate(Y, QuarterMonth, 1);
end;

function EndOfTheQuarter(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
  QuarterMonth: Integer;
begin
  DecodeDate(ADate, Y, M, D);
  QuarterMonth := ((M - 1) div 3) * 3 + 3;
  Result := EncodeDate(Y, QuarterMonth, 1);
  Result := IncMonth(Result, 1) - 1;
end;

function StartOfTheYear(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, 1, 1);
end;

function EndOfTheYear(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, 12, 31);
end;

end.
```

### Cr√©ation d'un rapport d'inventaire

Maintenant, cr√©ons un rapport d'inventaire pour suivre les niveaux de stock :

```pascal
procedure TDataModuleReports.PrepareInventoryReport;
begin
  // Configurer la requ√™te
  qryInventoryReport.Close;
  qryInventoryReport.SQL.Text :=
    'SELECT p.ProduitID, p.Reference, p.Designation, c.NomCategorie, ' +
    'f.RaisonSociale AS NomFournisseur, p.PrixAchat, p.PrixVente, ' +
    's.QuantiteDisponible, s.StockMinimum, ' +
    'CASE WHEN s.QuantiteDisponible <= 0 THEN ''Rupture'' ' +
    '     WHEN s.QuantiteDisponible < s.StockMinimum THEN ''Faible'' ' +
    '     ELSE ''Normal'' END AS StatutStock ' +
    'FROM Produits p ' +
    'LEFT JOIN Categories c ON p.CategoryID = c.CategoryID ' +
    'LEFT JOIN Fournisseurs f ON p.FournisseurID = f.FournisseurID ' +
    'LEFT JOIN Stock s ON p.ProduitID = s.ProduitID ' +
    'WHERE p.Actif = TRUE ' +
    'ORDER BY StatutStock, c.NomCategorie, p.Designation';

  qryInventoryReport.Open;
end;

procedure TDataModuleReports.ShowInventoryReport;
begin
  // V√©rifier que les donn√©es sont disponibles
  if qryInventoryReport.IsEmpty then
  begin
    ShowMessage('Aucune donn√©e d''inventaire disponible.');
    Exit;
  end;

  // Afficher l'aper√ßu du rapport
  frxReportInventory.ShowReport;
end;
```

## Cr√©ation d'un rapport d'analyse des ventes par p√©riode

Un rapport d'analyse des ventes est essentiel pour comprendre les performances commerciales. Impl√©mentons cette fonctionnalit√© :

```pascal
procedure TDataModuleReports.PrepareSalesByPeriodReport(const APeriodType: string);
var
  SQL, GroupBy, DateFormat: string;
begin
  // D√©finir le format et le regroupement en fonction de la p√©riode
  if APeriodType = 'DAY' then
  begin
    GroupBy := 'CAST(c.DateCommande AS DATE)';
    DateFormat := '%d/%m/%Y';
  end
  else if APeriodType = 'WEEK' then
  begin
    GroupBy := 'YEARWEEK(c.DateCommande, 1)';
    DateFormat := 'Semaine %v %Y';
  end
  else if APeriodType = 'MONTH' then
  begin
    GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
    DateFormat := '%m/%Y';
  end
  else if APeriodType = 'QUARTER' then
  begin
    GroupBy := 'YEAR(c.DateCommande), QUARTER(c.DateCommande)';
    DateFormat := 'Q%q %Y';
  end
  else // YEAR
  begin
    GroupBy := 'YEAR(c.DateCommande)';
    DateFormat := '%Y';
  end;

  // Construire la requ√™te SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS Periode, ' +
    'DATE_FORMAT(MIN(c.DateCommande), ''' + DateFormat + ''') AS PeriodeAffichage, ' +
    'COUNT(DISTINCT c.CommandeID) AS NombreCommandes, ' +
    'SUM(c.MontantHT) AS TotalHT, ' +
    'SUM(c.MontantTTC - c.MontantHT) AS TotalTVA, ' +
    'SUM(c.MontantTTC) AS TotalTTC, ' +
    'AVG(c.MontantTTC) AS PanierMoyen ' +
    'FROM Commandes c ' +
    'WHERE c.Statut NOT IN (''Annul√©e'') ' +
    'GROUP BY Periode ' +
    'ORDER BY MIN(c.DateCommande) DESC';

  // Ex√©cuter la requ√™te
  qrySalesByPeriod.Close;
  qrySalesByPeriod.SQL.Text := SQL;
  qrySalesByPeriod.Open;

  // Stocker le type de p√©riode pour le titre du rapport
  qrySalesByPeriod.FieldByName('PeriodeType').AsString := APeriodType;
end;

procedure TDataModuleReports.ShowSalesByPeriodReport;
begin
  // V√©rifier que les donn√©es sont disponibles
  if qrySalesByPeriod.IsEmpty then
  begin
    ShowMessage('Aucune donn√©e de ventes disponible.');
    Exit;
  end;

  // Afficher l'aper√ßu du rapport
  frxReportSalesByPeriod.ShowReport;
end;
```

## Cr√©ation d'un formulaire de s√©lection de p√©riode avanc√©

Pour permettre √† l'utilisateur de s√©lectionner pr√©cis√©ment la p√©riode qu'il souhaite analyser, cr√©ons un formulaire plus sophistiqu√© :

```pascal
unit FormReportPeriod;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.ComCtrls, Vcl.Buttons;

type
  TReportPeriodType = (rptDay, rptWeek, rptMonth, rptQuarter, rptYear, rptCustom);

  TfrmReportPeriod = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlPeriodType: TPanel;
    rbDay: TRadioButton;
    rbWeek: TRadioButton;
    rbMonth: TRadioButton;
    rbQuarter: TRadioButton;
    rbYear: TRadioButton;
    rbCustom: TRadioButton;
    pnlPredefined: TPanel;
    cboPredefined: TComboBox;
    lblPredefined: TLabel;
    pnlCustom: TPanel;
    lblStartDate: TLabel;
    dtpStartDate: TDateTimePicker;
    lblEndDate: TLabel;
    dtpEndDate: TDateTimePicker;
    pnlBottom: TPanel;
    btnGenerate: TButton;
    btnCancel: TButton;
    procedure FormCreate(Sender: TObject);
    procedure rbDayClick(Sender: TObject);
    procedure rbWeekClick(Sender: TObject);
    procedure rbMonthClick(Sender: TObject);
    procedure rbQuarterClick(Sender: TObject);
    procedure rbYearClick(Sender: TObject);
    procedure rbCustomClick(Sender: TObject);
    procedure cboPredefinedChange(Sender: TObject);
    procedure btnGenerateClick(Sender: TObject);
    procedure btnCancelClick(Sender: TObject);
  private
    { D√©clarations priv√©es }
    FPeriodType: TReportPeriodType;
    FStartDate: TDateTime;
    FEndDate: TDateTime;

    procedure UpdateControls;
    procedure UpdatePredefinedList;
    procedure UpdateDates;
  public
    { D√©clarations publiques }
    property PeriodType: TReportPeriodType read FPeriodType;
    property StartDate: TDateTime read FStartDate;
    property EndDate: TDateTime read FEndDate;

    function GetPeriodTypeString: string;
  end;

var
  frmReportPeriod: TfrmReportPeriod;

implementation

{$R *.dfm}

procedure TfrmReportPeriod.FormCreate(Sender: TObject);
begin
  // Valeurs par d√©faut
  FPeriodType := rptMonth;
  rbMonth.Checked := True;

  // Initialiser les contr√¥les
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.UpdateControls;
begin
  // Activer/d√©sactiver les contr√¥les selon le type de p√©riode
  pnlPredefined.Visible := FPeriodType <> rptCustom;
  pnlCustom.Visible := FPeriodType = rptCustom;

  // Configurer le DateTimePicker selon la p√©riode
  case FPeriodType of
    rptDay:
      begin
        dtpStartDate.Format := 'dd/MM/yyyy';
        dtpEndDate.Format := 'dd/MM/yyyy';
      end;
    rptWeek, rptMonth, rptQuarter, rptYear:
      begin
        dtpStartDate.Format := 'MMMM yyyy';
        dtpEndDate.Format := 'MMMM yyyy';
      end;
    rptCustom:
      begin
        dtpStartDate.Format := 'dd/MM/yyyy';
        dtpEndDate.Format := 'dd/MM/yyyy';
      end;
  end;
end;

procedure TfrmReportPeriod.UpdatePredefinedList;
begin
  cboPredefined.Items.Clear;

  case FPeriodType of
    rptDay:
      begin
        cboPredefined.Items.Add('Aujourd''hui');
        cboPredefined.Items.Add('Hier');
        cboPredefined.Items.Add('7 derniers jours');
        cboPredefined.Items.Add('30 derniers jours');
      end;
    rptWeek:
      begin
        cboPredefined.Items.Add('Cette semaine');
        cboPredefined.Items.Add('Semaine derni√®re');
        cboPredefined.Items.Add('4 derni√®res semaines');
        cboPredefined.Items.Add('13 derni√®res semaines');
      end;
    rptMonth:
      begin
        cboPredefined.Items.Add('Ce mois-ci');
        cboPredefined.Items.Add('Mois dernier');
        cboPredefined.Items.Add('3 derniers mois');
        cboPredefined.Items.Add('6 derniers mois');
        cboPredefined.Items.Add('12 derniers mois');
      end;
    rptQuarter:
      begin
        cboPredefined.Items.Add('Ce trimestre');
        cboPredefined.Items.Add('Trimestre dernier');
        cboPredefined.Items.Add('4 derniers trimestres');
      end;
    rptYear:
      begin
        cboPredefined.Items.Add('Cette ann√©e');
        cboPredefined.Items.Add('Ann√©e derni√®re');
        cboPredefined.Items.Add('3 derni√®res ann√©es');
        cboPredefined.Items.Add('5 derni√®res ann√©es');
      end;
  end;

  // S√©lectionner le premier √©l√©ment
  if cboPredefined.Items.Count > 0 then
    cboPredefined.ItemIndex := 0;
end;

procedure TfrmReportPeriod.UpdateDates;
var
  Y, M, D: Word;
  FirstDayOfWeek: Integer;
begin
  // Calculer les dates en fonction du type de p√©riode et de l'√©l√©ment s√©lectionn√©
  case FPeriodType of
    rptDay:
      case cboPredefined.ItemIndex of
        0: // Aujourd'hui
          begin
            FStartDate := Date;
            FEndDate := Date;
          end;
        1: // Hier
          begin
            FStartDate := Date - 1;
            FEndDate := Date - 1;
          end;
        2: // 7 derniers jours
          begin
            FStartDate := Date - 6;
            FEndDate := Date;
          end;
        3: // 30 derniers jours
          begin
            FStartDate := Date - 29;
            FEndDate := Date;
          end;
      end;

    rptWeek:
      begin
        // Trouver le premier jour de la semaine (lundi = 1)
        FirstDayOfWeek := DayOfWeek(Date);
        if FirstDayOfWeek = 1 then // Dimanche
          FirstDayOfWeek := 7
        else
          FirstDayOfWeek := FirstDayOfWeek - 1;

        case cboPredefined.ItemIndex of
          0: // Cette semaine
            begin
              FStartDate := Date - (FirstDayOfWeek - 1);
              FEndDate := FStartDate + 6;
            end;
          1: // Semaine derni√®re
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - 7;
              FEndDate := FStartDate + 6;
            end;
          2: // 4 derni√®res semaines
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - (3 * 7);
              FEndDate := Date;
            end;
          3: // 13 derni√®res semaines
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - (12 * 7);
              FEndDate := Date;
            end;
        end;
      end;

    rptMonth:
      begin
        DecodeDate(Date, Y, M, D);

        case cboPredefined.ItemIndex of
          0: // Ce mois-ci
            begin
              FStartDate := EncodeDate(Y, M, 1);
              FEndDate := IncMonth(FStartDate, 1) - 1;
            end;
          1: // Mois dernier
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -1);
              FEndDate := EncodeDate(Y, M, 1) - 1;
            end;
          2: // 3 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -2);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
          3: // 6 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -5);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
          4: // 12 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -11);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
        end;
      end;

    rptQuarter:
      begin
        DecodeDate(Date, Y, M, D);
        // Calculer le premier mois du trimestre (1, 4, 7 ou 10)
        M := ((M - 1) div 3) * 3 + 1;

        case cboPredefined.ItemIndex of
          0: // Ce trimestre
            begin
              FStartDate := EncodeDate(Y, M, 1);
              FEndDate := IncMonth(FStartDate, 3) - 1;
            end;
          1: // Trimestre dernier
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -3);
              FEndDate := EncodeDate(Y, M, 1) - 1;
            end;
          2: // 4 derniers trimestres
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -9);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 3) - 1;
            end;
        end;
      end;

    rptYear:
      begin
        DecodeDate(Date, Y, M, D);

        case cboPredefined.ItemIndex of
          0: // Cette ann√©e
            begin
              FStartDate := EncodeDate(Y, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
          1: // Ann√©e derni√®re
            begin
              FStartDate := EncodeDate(Y - 1, 1, 1);
              FEndDate := EncodeDate(Y - 1, 12, 31);
            end;
          2: // 3 derni√®res ann√©es
            begin
              FStartDate := EncodeDate(Y - 2, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
          3: // 5 derni√®res ann√©es
            begin
              FStartDate := EncodeDate(Y - 4, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
        end;
      end;

    rptCustom:
      begin
        // Pour la p√©riode personnalis√©e, utiliser les valeurs des DateTimePickers
        FStartDate := dtpStartDate.Date;
        FEndDate := dtpEndDate.Date;
      end;
  end;

  // Mettre √† jour les DateTimePickers
  dtpStartDate.Date := FStartDate;
  dtpEndDate.Date := FEndDate;
end;

procedure TfrmReportPeriod.rbDayClick(Sender: TObject);
begin
  FPeriodType := rptDay;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbWeekClick(Sender: TObject);
begin
  FPeriodType := rptWeek;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbMonthClick(Sender: TObject);
begin
  FPeriodType := rptMonth;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbQuarterClick(Sender: TObject);
begin
  FPeriodType := rptQuarter;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbYearClick(Sender: TObject);
begin
  FPeriodType := rptYear;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbCustomClick(Sender: TObject);
begin
  FPeriodType := rptCustom;
  UpdateControls;

  // Pour la p√©riode personnalis√©e, initialiser avec le mois en cours
  dtpStartDate.Date := StartOfTheMonth(Date);
  dtpEndDate.Date := EndOfTheMonth(Date);
  UpdateDates;
end;

procedure TfrmReportPeriod.cboPredefinedChange(Sender: TObject);
begin
  UpdateDates;
end;

procedure TfrmReportPeriod.btnGenerateClick(Sender: TObject);
begin
  // Si p√©riode personnalis√©e, v√©rifier que les dates sont valides
  if FPeriodType = rptCustom then
  begin
    FStartDate := dtpStartDate.Date;
    FEndDate := dtpEndDate.Date;

    if FStartDate > FEndDate then
    begin
      ShowMessage('La date de d√©but doit √™tre ant√©rieure √† la date de fin.');
      Exit;
    end;
  end;

  ModalResult := mrOk;
end;

procedure TfrmReportPeriod.btnCancelClick(Sender: TObject);
begin
  ModalResult := mrCancel;
end;

function TfrmReportPeriod.GetPeriodTypeString: string;
begin
  case FPeriodType of
    rptDay: Result := 'DAY';
    rptWeek: Result := 'WEEK';
    rptMonth: Result := 'MONTH';
    rptQuarter: Result := 'QUARTER';
    rptYear: Result := 'YEAR';
    rptCustom: Result := 'CUSTOM';
  end;
end;

end.
```

## Int√©gration de graphiques avanc√©s avec TeeChart Pro

Pour des visualisations plus sophistiqu√©es, nous pouvons utiliser les fonctionnalit√©s avanc√©es de TeeChart Pro :

```pascal
procedure TfrmDashboard.CreateAdvancedCharts;
var
  Series1: TPieSeries;
  Series2: TBarSeries;
  Series3: TFastLineSeries;
begin
  // Graphique d'analyse des ventes par cat√©gorie (camembert)
  Series1 := TPieSeries.Create(chartCategories);
  with Series1 do
  begin
    ParentChart := chartCategories;
    Title := 'Ventes par cat√©gorie';
    Marks.Style := smsLabelPercent;
    Marks.Arrow.Visible := True;
    Circled := True;
    ExplodeBiggest := 20;

    // Ajouter les valeurs (√† remplacer par des donn√©es r√©elles)
    Add(1250, 'Informatique', clRed);
    Add(850, 'Bureautique', clBlue);
    Add(620, 'Mobilier', clGreen);
    Add(410, 'Consommables', clYellow);
    Add(320, 'Accessoires', clPurple);
  end;

  // Configuration du graphique
  with chartCategories do
  begin
    Title.Text.Clear;
    Title.Text.Add('R√©partition des ventes par cat√©gorie');
    Title.Font.Size := 12;
    Legend.Visible := True;
    View3D := True;
    View3DOptions.Elevation := 315;
    View3DOptions.Perspective := 0;
    View3DOptions.Rotation := 360;
  end;

  // Graphique de tendance des ventes (courbes)
  Series3 := TFastLineSeries.Create(chartTrend);
  with Series3 do
  begin
    ParentChart := chartTrend;
    Title := 'Ventes';
    LinePen.Width := 3;
    LinePen.Color := clBlue;
    Pointer.Visible := True;
    Pointer.Style := psCircle;
    Pointer.Size := 4;

    // Ajouter les valeurs (√† remplacer par des donn√©es r√©elles)
    for var i := 1 to 12 do
      AddXY(i, Random(1000) + 500, FormatFloat('00', i) + '/2023');
  end;

  // Configuration du graphique
  with chartTrend do
  begin
    Title.Text.Clear;
    Title.Text.Add('Tendance des ventes sur 12 mois');
    Title.Font.Size := 12;
    BottomAxis.Title.Caption := 'P√©riode';
    LeftAxis.Title.Caption := 'Montant (‚Ç¨)';
    Legend.Visible := False;
    View3D := False;
    BottomAxis.Grid.Visible := False;
    LeftAxis.Grid.Visible := True;
    LeftAxis.Grid.Style := psDot;
  end;

  // Graphique comparatif mensuel (histogramme)
  Series2 := TBarSeries.Create(chartMonthly);
  with Series2 do
  begin
    ParentChart := chartMonthly;
    Title := 'Cette ann√©e';
    Marks.Visible := True;
    Marks.Style := smsValue;
    BarStyle := bsRectangle;
    Color := clBlue;

    // Ajouter les valeurs (√† remplacer par des donn√©es r√©elles)
    for var i := 1 to 12 do
      Add(Random(1000) + 500, ShortMonthNames[i]);
  end;

  // Ajouter une seconde s√©rie pour la comparaison
  Series2 := TBarSeries.Create(chartMonthly);
  with Series2 do
  begin
    ParentChart := chartMonthly;
    Title := 'Ann√©e pr√©c√©dente';
    Marks.Visible := False;
    BarStyle := bsRectangle;
    Color := clRed;

    // Ajouter les valeurs (√† remplacer par des donn√©es r√©elles)
    for var i := 1 to 12 do
      Add(Random(1000) + 300, ShortMonthNames[i]);
  end;

  // Configuration du graphique
  with chartMonthly do
  begin
    Title.Text.Clear;
    Title.Text.Add('Comparaison mensuelle des ventes');
    Title.Font.Size := 12;
    BottomAxis.Title.Caption := 'Mois';
    LeftAxis.Title.Caption := 'Montant (‚Ç¨)';
    Legend.Visible := True;
    View3D := False;
    BottomAxis.Grid.Visible := False;
    LeftAxis.Grid.Visible := True;
    LeftAxis.Grid.Style := psDot;
    SeriesList.MultiBar := mbSide;
  end;
end;
```

## Cr√©ation d'un tableau de bord interactif avec des indicateurs cl√©s de performance (KPI)

Un tableau de bord efficace doit mettre en avant les indicateurs cl√©s de performance (KPI). Cr√©ons un formulaire sp√©cifique pour cela :

```pascal
unit FormKpiDashboard;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.Imaging.pngimage, Vcl.ComCtrls, Data.DB, FireDAC.Comp.Client, dmDatabase,
  VclTee.TeeGDIPlus, VclTee.TeEngine, VclTee.TeeProcs, VclTee.Chart, VclTee.Series;

type
  TKpiPanel = class(TPanel)
  private
    FTitleLabel: TLabel;
    FValueLabel: TLabel;
    FChangeLabel: TLabel;
    FIcon: TImage;
  public
    constructor Create(AOwner: TComponent); override;

    procedure SetKpi(const ATitle: string; AValue: Double; AChange: Double;
      const AFormatStr: string = '#,##0');
  end;

  TfrmKpiDashboard = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    cboDateRange: TComboBox;
    lblDateRange: TLabel;
    pnlMain: TPanel;
    pnlKpi: TPanel;
    pnlCharts: TPanel;
    chartSales: TChart;
    chartCustomers: TChart;
    seriesSales: TLineSeries;
    seriesCustomers: TLineSeries;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure cboDateRangeChange(Sender: TObject);
  private
    { D√©clarations priv√©es }
    FKpiPanels: array[0..3] of TKpiPanel;
    FSalesQuery: TFDQuery;
    FCustomersQuery: TFDQuery;

    procedure CreateKpiPanels;
    procedure LoadKpiData;
    procedure LoadChartData;
    function GetDateRange: TDateRange;
  public
    { D√©clarations publiques }
  end;

var
  frmKpiDashboard: TfrmKpiDashboard;

implementation

{$R *.dfm}

// Impl√©mentation de TKpiPanel

constructor TKpiPanel.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);

  // Configurer le panel
  BevelOuter := bvNone;
  ParentBackground := False;

  // Cr√©er le label de titre
  FTitleLabel := TLabel.Create(Self);
  FTitleLabel.Parent := Self;
  FTitleLabel.Align := alTop;
  FTitleLabel.Alignment := taCenter;
  FTitleLabel.Font.Style := [fsBold];
  FTitleLabel.Height := 20;

  // Cr√©er le label de valeur
  FValueLabel := TLabel.Create(Self);
  FValueLabel.Parent := Self;
  FValueLabel.Align := alClient;
  FValueLabel.Alignment := taCenter;
  FValueLabel.Layout := tlCenter;
  FValueLabel.Font.Size := 20;
  FValueLabel.Font.Style := [fsBold];

  // Cr√©er le label de variation
  FChangeLabel := TLabel.Create(Self);
  FChangeLabel.Parent := Self;
  FChangeLabel.Align := alBottom;
  FChangeLabel.Alignment := taCenter;
  FChangeLabel.Height := 20;

  // Cr√©er l'ic√¥ne
  FIcon := TImage.Create(Self);
  FIcon.Parent := Self;
  FIcon.Align := alRight;
  FIcon.Width := 32;
  FIcon.Transparent := True;
  FIcon.Visible := False;
end;

procedure TKpiPanel.SetKpi(const ATitle: string; AValue: Double; AChange: Double;
  const AFormatStr: string = '#,##0');
begin
  // D√©finir le titre
  FTitleLabel.Caption := ATitle;

  // D√©finir la valeur
  FValueLabel.Caption := FormatFloat(AFormatStr, AValue);

  // D√©finir la variation
  if AChange > 0 then
  begin
    FChangeLabel.Caption := '‚ñ≤ ' + FormatFloat('+0.0%', AChange);
    FChangeLabel.Font.Color := clGreen;
  end
  else if AChange < 0 then
  begin
    FChangeLabel.Caption := '‚ñº ' + FormatFloat('0.0%', AChange);
    FChangeLabel.Font.Color := clRed;
  end
  else
  begin
    FChangeLabel.Caption := '‚óé 0.0%';
    FChangeLabel.Font.Color := clGray;
  end;
end;

// Impl√©mentation de TfrmKpiDashboard

procedure TfrmKpiDashboard.FormCreate(Sender: TObject);
begin
  // Cr√©er les requ√™tes
  FSalesQuery := TFDQuery.Create(Self);
  FSalesQuery.Connection := DataModuleDB.FDConnection;

  FCustomersQuery := TFDQuery.Create(Self);
  FCustomersQuery.Connection := DataModuleDB.FDConnection;

  // Cr√©er les panneaux KPI
  CreateKpiPanels;

  // Remplir la combobox des p√©riodes
  cboDateRange.Items.Clear;
  cboDateRange.Items.Add('7 derniers jours');
  cboDateRange.Items.Add('30 derniers jours');
  cboDateRange.Items.Add('Ce mois-ci');
  cboDateRange.Items.Add('Ce trimestre');
  cboDateRange.Items.Add('Cette ann√©e');
  cboDateRange.ItemIndex := 2; // Ce mois-ci par d√©faut

  // Charger les donn√©es
  LoadKpiData;
  LoadChartData;
end;

procedure TfrmKpiDashboard.FormDestroy(Sender: TObject);
begin
  FSalesQuery.Free;
  FCustomersQuery.Free;
end;

procedure TfrmKpiDashboard.CreateKpiPanels;
var
  i: Integer;
begin
  // Cr√©er 4 panneaux KPI
  for i := 0 to 3 do
  begin
    FKpiPanels[i] := TKpiPanel.Create(Self);
    FKpiPanels[i].Parent := pnlKpi;
    FKpiPanels[i].Align := alLeft;
    FKpiPanels[i].Width := (pnlKpi.Width div 4) - 10;
    FKpiPanels[i].Margins.Left := 5;
    FKpiPanels[i].Margins.Right := 5;
    FKpiPanels[i].Margins.Top := 5;
    FKpiPanels[i].Margins.Bottom := 5;
    FKpiPanels[i].AlignWithMargins := True;

    // Couleurs des panneaux
    case i of
      0: FKpiPanels[i].Color := $00D1E7F6; // Bleu clair
      1: FKpiPanels[i].Color := $00D1F6D7; // Vert clair
      2: FKpiPanels[i].Color := $00F6EAD1; // Orange clair
      3: FKpiPanels[i].Color := $00F6D1D1; // Rouge clair
    end;
  end;
end;

procedure TfrmKpiDashboard.LoadKpiData;
var
  DateRange: TDateRange;
  StartDate, EndDate, PrevStartDate, PrevEndDate: TDateTime;
  CurrentCA, PreviousCA: Double;
  CurrentOrders, PreviousOrders: Integer;
  CurrentNewCustomers, PreviousNewCustomers: Integer;
  CurrentAvgOrder, PreviousAvgOrder: Double;
  Variation: Double;
begin
  // D√©terminer la p√©riode
  DateRange := GetDateRange;

  // P√©riode actuelle
  StartDate := DateRange.StartDate;
  EndDate := DateRange.EndDate;

  // P√©riode pr√©c√©dente (m√™me dur√©e que la p√©riode actuelle)
  PrevStartDate := StartDate - (EndDate - StartDate + 1);
  PrevEndDate := StartDate - 1;

  // 1. Chiffre d'affaires
  FSalesQuery.Close;
  FSalesQuery.SQL.Text :=
    'SELECT SUM(MontantTTC) AS TotalCA FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annul√©e'')';

  // P√©riode actuelle
  FSalesQuery.ParamByName('StartDate').AsDate := StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := EndDate;
  FSalesQuery.Open;
  CurrentCA := FSalesQuery.FieldByName('TotalCA').AsFloat;

  // P√©riode pr√©c√©dente
  FSalesQuery.Close;
  FSalesQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FSalesQuery.Open;
  PreviousCA := FSalesQuery.FieldByName('TotalCA').AsFloat;

  // Calculer la variation en pourcentage
  if PreviousCA > 0 then
    Variation := ((CurrentCA - PreviousCA) / PreviousCA) * 100
  else
    Variation := 0;

  // Mettre √† jour le KPI
  FKpiPanels[0].SetKpi('Chiffre d''affaires', CurrentCA, Variation, '#,##0.00 ‚Ç¨');

  // 2. Nombre de commandes
  FSalesQuery.Close;
  FSalesQuery.SQL.Text :=
    'SELECT COUNT(*) AS TotalOrders FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annul√©e'')';

  // P√©riode actuelle
  FSalesQuery.ParamByName('StartDate').AsDate := StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := EndDate;
  FSalesQuery.Open;
  CurrentOrders := FSalesQuery.FieldByName('TotalOrders').AsInteger;

  // P√©riode pr√©c√©dente
  FSalesQuery.Close;
  FSalesQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FSalesQuery.Open;
  PreviousOrders := FSalesQuery.FieldByName('TotalOrders').AsInteger;

  // Calculer la variation
  if PreviousOrders > 0 then
    Variation := ((CurrentOrders - PreviousOrders) / PreviousOrders) * 100
  else
    Variation := 0;

  // Mettre √† jour le KPI
  FKpiPanels[1].SetKpi('Nombre de commandes', CurrentOrders, Variation);

  // 3. Nouveaux clients
  FCustomersQuery.Close;
  FCustomersQuery.SQL.Text :=
    'SELECT COUNT(*) AS NewCustomers FROM Clients ' +
    'WHERE DateCreation BETWEEN :StartDate AND :EndDate';

  // P√©riode actuelle
  FCustomersQuery.ParamByName('StartDate').AsDate := StartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := EndDate;
  FCustomersQuery.Open;
  CurrentNewCustomers := FCustomersQuery.FieldByName('NewCustomers').AsInteger;

  // P√©riode pr√©c√©dente
  FCustomersQuery.Close;
  FCustomersQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FCustomersQuery.Open;
  PreviousNewCustomers := FCustomersQuery.FieldByName('NewCustomers').AsInteger;

  // Calculer la variation
  if PreviousNewCustomers > 0 then
    Variation := ((CurrentNewCustomers - PreviousNewCustomers) / PreviousNewCustomers) * 100
  else
    Variation := 0;

  // Mettre √† jour le KPI
  FKpiPanels[2].SetKpi('Nouveaux clients', CurrentNewCustomers, Variation);

  // 4. Panier moyen
  if CurrentOrders > 0 then
    CurrentAvgOrder := CurrentCA / CurrentOrders
  else
    CurrentAvgOrder := 0;

  if PreviousOrders > 0 then
    PreviousAvgOrder := PreviousCA / PreviousOrders
  else
    PreviousAvgOrder := 0;

  // Calculer la variation
  if PreviousAvgOrder > 0 then
    Variation := ((CurrentAvgOrder - PreviousAvgOrder) / PreviousAvgOrder) * 100
  else
    Variation := 0;

  // Mettre √† jour le KPI
  FKpiPanels[3].SetKpi('Panier moyen', CurrentAvgOrder, Variation, '#,##0.00 ‚Ç¨');
end;

procedure TfrmKpiDashboard.LoadChartData;
var
  DateRange: TDateRange;
  SQL: string;
  DateFormat, GroupBy: string;
begin
  // D√©terminer le format de date et le regroupement en fonction de la p√©riode
  case cboDateRange.ItemIndex of
    0, 1: // 7 ou 30 derniers jours
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
    2: // Ce mois-ci
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
    3: // Ce trimestre
      begin
        DateFormat := '%v';
        GroupBy := 'YEARWEEK(DateCommande)';
      end;
    4: // Cette ann√©e
      begin
        DateFormat := '%m/%Y';
        GroupBy := 'YEAR(DateCommande), MONTH(DateCommande)';
      end;
    else
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
  end;

  // Obtenir la p√©riode
  DateRange := GetDateRange;

  // Charger les donn√©es des ventes
  seriesSales.Clear;

  FSalesQuery.Close;
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroup, ' +
    'DATE_FORMAT(DateCommande, ''' + DateFormat + ''') AS DateDisplay, ' +
    'SUM(MontantTTC) AS TotalSales ' +
    'FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annul√©e'') ' +
    'GROUP BY DateGroup ' +
    'ORDER BY DateGroup';
  FSalesQuery.SQL.Text := SQL;
  FSalesQuery.ParamByName('StartDate').AsDate := DateRange.StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := DateRange.EndDate;
  FSalesQuery.Open;

  while not FSalesQuery.Eof do
  begin
    seriesSales.AddXY(
      seriesSales.Count + 1,
      FSalesQuery.FieldByName('TotalSales').AsFloat,
      FSalesQuery.FieldByName('DateDisplay').AsString
    );
    FSalesQuery.Next;
  end;

  // Configurer le graphique des ventes
  chartSales.Title.Text.Clear;
  chartSales.Title.Text.Add('√âvolution des ventes');
  chartSales.LeftAxis.Title.Caption := 'Montant (‚Ç¨)';
  chartSales.BottomAxis.Title.Caption := 'P√©riode';

  // Charger les donn√©es des nouveaux clients
  seriesCustomers.Clear;

  FCustomersQuery.Close;
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroup, ' +
    'DATE_FORMAT(DateCreation, ''' + DateFormat + ''') AS DateDisplay, ' +
    'COUNT(*) AS NewCustomers ' +
    'FROM Clients ' +
    'WHERE DateCreation BETWEEN :StartDate AND :EndDate ' +
    'GROUP BY DateGroup ' +
    'ORDER BY DateGroup';
  FCustomersQuery.SQL.Text := SQL;
  FCustomersQuery.ParamByName('StartDate').AsDate := DateRange.StartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := DateRange.EndDate;
  FCustomersQuery.Open;

  while not FCustomersQuery.Eof do
  begin
    seriesCustomers.AddXY(
      seriesCustomers.Count + 1,
      FCustomersQuery.FieldByName('NewCustomers').AsFloat,
      FCustomersQuery.FieldByName('DateDisplay').AsString
    );
    FCustomersQuery.Next;
  end;

  // Configurer le graphique des clients
  chartCustomers.Title.Text.Clear;
  chartCustomers.Title.Text.Add('Nouveaux clients');
  chartCustomers.LeftAxis.Title.Caption := 'Nombre';
  chartCustomers.BottomAxis.Title.Caption := 'P√©riode';
end;

function TfrmKpiDashboard.GetDateRange: TDateRange;
var
  Y, M, D: Word;
begin
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        Result.StartDate := Date - 6;
        Result.EndDate := Date;
      end;
    1: // 30 derniers jours
      begin
        Result.StartDate := Date - 29;
        Result.EndDate := Date;
      end;
    2: // Ce mois-ci
      begin
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 1) - 1;
      end;
    3: // Ce trimestre
      begin
        DecodeDate(Date, Y, M, D);
        // Calculer le premier mois du trimestre (1, 4, 7 ou 10)
        M := ((M - 1) div 3) * 3 + 1;
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 3) - 1;
      end;
    4: // Cette ann√©e
      begin
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, 1, 1);
        Result.EndDate := EncodeDate(Y, 12, 31);
      end;
    else
      begin
        // Par d√©faut, ce mois-ci
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 1) - 1;
      end;
  end;
end;

procedure TfrmKpiDashboard.cboDateRangeChange(Sender: TObject);
begin
  LoadKpiData;
  LoadChartData;
end;
```

## Cr√©ation d'un rapport de performance commerciale

Un rapport de performance commerciale est essentiel pour suivre les r√©sultats de l'√©quipe de vente. Cr√©ons ce rapport :

```pascal
procedure TDataModuleReports.PrepareSalesPerformanceReport;
begin
  // Configurer la requ√™te
  qrySalesPerformance.Close;
  qrySalesPerformance.SQL.Text :=
    'SELECT u.UtilisateurID, CONCAT(u.Nom, '' '', u.Prenom) AS Vendeur, ' +
    'COUNT(c.CommandeID) AS NombreCommandes, ' +
    'SUM(c.MontantHT) AS TotalHT, ' +
    'SUM(c.MontantTTC) AS TotalTTC, ' +
    'MAX(c.MontantTTC) AS CommandeMax, ' +
    'AVG(c.MontantTTC) AS CommandeMoyenne, ' +
    '(SELECT COUNT(DISTINCT c2.ClientID) ' +
    ' FROM Commandes c2 ' +
    ' WHERE c2.UtilisateurID = u.UtilisateurID ' +
    ' AND c2.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    ' AND c2.Statut NOT IN (''Annul√©e'')) AS NombreClients ' +
    'FROM Utilisateurs u ' +
    'LEFT JOIN Commandes c ON u.UtilisateurID = c.UtilisateurID ' +
    'AND c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annul√©e'') ' +
    'WHERE u.RoleID = 2 ' + // Supposons que RoleID 2 = Vendeurs
    'GROUP BY u.UtilisateurID ' +
    'ORDER BY TotalTTC DESC';

  qrySalesPerformance.ParamByName('DateDebut').AsDate := Date - 30; // Par d√©faut, 30 derniers jours
  qrySalesPerformance.ParamByName('DateFin').AsDate := Date;
  qrySalesPerformance.Open;
end;

procedure TDataModuleReports.PrepareSalesPerformanceDetailReport(AUtilisateurID: Integer);
begin
  // Configurer la requ√™te pour le d√©tail des commandes d'un vendeur
  qrySalesPerformanceDetail.Close;
  qrySalesPerformanceDetail.SQL.Text :=
    'SELECT c.CommandeID, c.Reference, c.DateCommande, ' +
    'CONCAT(cl.Nom, '' '', cl.Prenom) AS Client, ' +
    'c.MontantHT, c.MontantTTC, c.Statut, ' +
    '(SELECT COUNT(*) FROM LignesCommande l WHERE l.CommandeID = c.CommandeID) AS NbProduits ' +
    'FROM Commandes c ' +
    'JOIN Clients cl ON c.ClientID = cl.ClientID ' +
    'WHERE c.UtilisateurID = :UtilisateurID ' +
    'AND c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annul√©e'') ' +
    'ORDER BY c.DateCommande DESC';

  qrySalesPerformanceDetail.ParamByName('UtilisateurID').AsInteger := AUtilisateurID;
  qrySalesPerformanceDetail.ParamByName('DateDebut').AsDate := Date - 30;
  qrySalesPerformanceDetail.ParamByName('DateFin').AsDate := Date;
  qrySalesPerformanceDetail.Open;
end;
```

## Exportation des rapports et tableaux de bord

Pour terminer, impl√©mentons une fonctionnalit√© pour exporter nos rapports et tableaux de bord dans diff√©rents formats :

```pascal
procedure TfrmDashboard.ExportToPdf;
var
  SaveDialog: TSaveDialog;
  FileName: string;
  MetaFile: TMetafile;
  Canvas: TMetafileCanvas;
  R: TRect;
begin
  SaveDialog := TSaveDialog.Create(nil);
  try
    SaveDialog.Title := 'Exporter le tableau de bord en PDF';
    SaveDialog.Filter := 'Fichiers PDF (*.pdf)|*.pdf';
    SaveDialog.DefaultExt := 'pdf';
    SaveDialog.FileName := 'tableau_bord_' + FormatDateTime('yyyymmdd', Date) + '.pdf';

    if SaveDialog.Execute then
    begin
      FileName := SaveDialog.FileName;

      // Cr√©er un PDF avec ReportBuilder, FastReport ou une autre biblioth√®que
      // Voici un exemple qui cr√©e un m√©tafichier de la forme actuelle

      // Cr√©er un m√©tafichier
      R := Rect(0, 0, Self.Width, Self.Height);
      MetaFile := TMetafile.Create;
      try
        MetaFile.Width := Self.Width;
        MetaFile.Height := Self.Height;

        Canvas := TMetafileCanvas.Create(MetaFile, 0);
        try
          Self.PaintTo(Canvas, 0, 0);
        finally
          Canvas.Free;
        end;

        // Sauvegarder le m√©tafichier dans un PDF
        // (Cette partie n√©cessite une biblioth√®que PDF comme SynPDF ou TPDF)
        // Ici, nous montrons simplement un message de succ√®s
        ShowMessage('Export PDF cr√©√© avec succ√®s : ' + FileName);
      finally
        MetaFile.Free;
      end;
    end;
  finally
    SaveDialog.Free;
  end;
end;

procedure TfrmDashboard.ExportToExcel;
var
  SaveDialog: TSaveDialog;
  FileName: string;
  Excel: Variant;
  Sheet: Variant;
  i, Col, Row: Integer;
begin
  SaveDialog := TSaveDialog.Create(nil);
  try
    SaveDialog.Title := 'Exporter les donn√©es en Excel';
    SaveDialog.Filter := 'Fichiers Excel (*.xlsx)|*.xlsx';
    SaveDialog.DefaultExt := 'xlsx';
    SaveDialog.FileName := 'donnees_' + FormatDateTime('yyyymmdd', Date) + '.xlsx';

    if SaveDialog.Execute then
    begin
      FileName := SaveDialog.FileName;

      // Utiliser la biblioth√®que OLE Automation pour Excel
      try
        Excel := CreateOleObject('Excel.Application');
        Excel.Visible := False;
        Excel.Workbooks.Add;
        Sheet := Excel.Workbooks[1].Worksheets[1];

        // Titre du rapport
        Sheet.Cells[1, 1] := 'Tableau de bord - Donn√©es';
        Sheet.Cells[1, 1].Font.Bold := True;
        Sheet.Cells[1, 1].Font.Size := 14;

        // En-t√™tes (exemple)
        Sheet.Cells[3, 1] := 'P√©riode';
        Sheet.Cells[3, 2] := 'Ventes';
        Sheet.Cells[3, 3] := 'Nouveaux clients';

        // Boucle pour ajouter les donn√©es (exemple simplifi√©)
        for i := 0 to seriesSales.Count - 1 do
        begin
          Row := i + 4;
          Sheet.Cells[Row, 1] := seriesSales.XLabel[i];
          Sheet.Cells[Row, 2] := seriesSales.YValue[i];

          if i < seriesCustomers.Count then
            Sheet.Cells[Row, 3] := seriesCustomers.YValue[i];
        end;

        // Formatage
        Sheet.Range['A3:C3'].Font.Bold := True;
        Sheet.Range['A1:C' + IntToStr(seriesSales.Count + 4)].Columns.AutoFit;

        // Sauvegarder et fermer
        Excel.Workbooks[1].SaveAs(FileName);
        Excel.Quit;

        ShowMessage('Export Excel cr√©√© avec succ√®s : ' + FileName);
      except
        on E: Exception do
          ShowMessage('Erreur lors de l''export Excel : ' + E.Message);
      end;
    end;
  finally
    SaveDialog.Free;
    Excel := Unassigned;
  end;
end;
```

## Int√©gration d'un s√©lecteur de rapports

Pour faciliter l'acc√®s √† tous les rapports, cr√©ons un formulaire centralis√© :

```pascal
unit FormReportSelector;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Imaging.pngimage, dmReports, FormReportPeriod;

type
  TfrmReportSelector = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlClient: TPanel;
    flpnlReports: TFlowPanel;
    pnlBottom: TPanel;
    btnClose: TButton;
    procedure FormCreate(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { D√©clarations priv√©es }
    procedure CreateReportButtons;
    procedure ReportButtonClick(Sender: TObject);
  public
    { D√©clarations publiques }
  end;

var
  frmReportSelector: TfrmReportSelector;

implementation

{$R *.dfm}

uses
  FormSalesReport, FormInventoryReport, FormSalesPerformanceReport,
  FormCustomerAnalysisReport, FormDashboard, FormKpiDashboard;

procedure TfrmReportSelector.FormCreate(Sender: TObject);
begin
  CreateReportButtons;
end;

procedure TfrmReportSelector.CreateReportButtons;
type
  TReportInfo = record
    Title: string;
    Description: string;
    FormClass: TFormClass;
    ImageName: string;
  end;
var
  Reports: array[0..5] of TReportInfo;
  Panel: TPanel;
  Image: TImage;
  LblTitle, LblDesc: TLabel;
  i: Integer;
begin
  // D√©finir les rapports disponibles
  Reports[0].Title := 'Rapport des ventes';
  Reports[0].Description := 'Analyse des ventes par p√©riode';
  Reports[0].FormClass := TfrmSalesReport;
  Reports[0].ImageName := 'report_sales.png';

  Reports[1].Title := '√âtat des stocks';
  Reports[1].Description := 'Inventaire et niveaux de stock';
  Reports[1].FormClass := TfrmInventoryReport;
  Reports[1].ImageName := 'report_inventory.png';

  Reports[2].Title := 'Performance commerciale';
  Reports[2].Description := 'Analyse des performances des vendeurs';
  Reports[2].FormClass := TfrmSalesPerformanceReport;
  Reports[2].ImageName := 'report_performance.png';

  Reports[3].Title := 'Analyse clients';
  Reports[3].Description := 'Statistiques et comportements clients';
  Reports[3].FormClass := TfrmCustomerAnalysisReport;
  Reports[3].ImageName := 'report_customers.png';

  Reports[4].Title := 'Tableau de bord';
  Reports[4].Description := 'Vue d''ensemble de l''activit√©';
  Reports[4].FormClass := TfrmDashboard;
  Reports[4].ImageName := 'dashboard.png';

  Reports[5].Title := 'KPI';
  Reports[5].Description := 'Indicateurs cl√©s de performance';
  Reports[5].FormClass := TfrmKpiDashboard;
  Reports[5].ImageName := 'kpi.png';

  // Cr√©er les boutons de rapport
  for i := 0 to High(Reports) do
  begin
    Panel := TPanel.Create(Self);
    Panel.Parent := flpnlReports;
    Panel.Width := 200;
    Panel.Height := 150;
    Panel.Padding.SetBounds(5, 5, 5, 5);
    Panel.BevelOuter := bvNone;
    Panel.ParentBackground := False;
    Panel.ParentColor := False;
    Panel.Color := clWhite;
    Panel.Tag := i; // Stocker l'index pour l'√©v√©nement OnClick
    Panel.OnClick := ReportButtonClick;
    Panel.Cursor := crHandPoint;

    // Ajouter l'image
    Image := TImage.Create(Panel);
    Image.Parent := Panel;
    Image.Align := alTop;
    Image.Height := 64;
    Image.Center := True;
    Image.Proportional := True;
    Image.Transparent := True;

    // Charger l'image si elle existe
    try
      if FileExists(ExtractFilePath(Application.ExeName) + 'Resources\Images\' + Reports[i].ImageName) then
        Image.Picture.LoadFromFile(ExtractFilePath(Application.ExeName) + 'Resources\Images\' + Reports[i].ImageName);
    except
      // Ignorer les erreurs de chargement d'image
    end;

    // Ajouter le titre
    LblTitle := TLabel.Create(Panel);
    LblTitle.Parent := Panel;
    LblTitle.Align := alTop;
    LblTitle.Alignment := taCenter;
    LblTitle.Font.Style := [fsBold];
    LblTitle.Font.Size := 10;
    LblTitle.Caption := Reports[i].Title;
    LblTitle.Top := Image.Height + 10;
    LblTitle.Height := 20;

    // Ajouter la description
    LblDesc := TLabel.Create(Panel);
    LblDesc.Parent := Panel;
    LblDesc.Align := alClient;
    LblDesc.Alignment := taCenter;
    LblDesc.WordWrap := True;
    LblDesc.Caption := Reports[i].Description;
  end;
end;

procedure TfrmReportSelector.ReportButtonClick(Sender: TObject);
var
  Panel: TPanel;
  ReportIndex: Integer;
  Form: TForm;
begin
  if Sender is TPanel then
  begin
    Panel := TPanel(Sender);
    ReportIndex := Panel.Tag;

    // Cr√©er et afficher le formulaire correspondant
    case ReportIndex of
      0: // Rapport des ventes
        begin
          Form := TfrmSalesReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      1: // √âtat des stocks
        begin
          Form := TfrmInventoryReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      2: // Performance commerciale
        begin
          Form := TfrmSalesPerformanceReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      3: // Analyse clients
        begin
          Form := TfrmCustomerAnalysisReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      4: // Tableau de bord
        begin
          Form := TfrmDashboard.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      5: // KPI
        begin
          Form := TfrmKpiDashboard.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
    end;
  end;
end;

procedure TfrmReportSelector.btnCloseClick(Sender: TObject);
begin
  Close;
end;

end.
```

## Conclusion

Dans cette section, nous avons d√©velopp√© un syst√®me complet de rapports et tableaux de bord pour notre application de gestion avec MySQL/MariaDB. Ces fonctionnalit√©s permettent aux utilisateurs d'analyser leurs donn√©es commerciales et de prendre des d√©cisions √©clair√©es.

### Points cl√©s abord√©s :

1. **Rapports statiques avec FastReport**
   - Rapports de ventes
   - √âtats d'inventaire
   - Analyses commerciales
   - Exportation dans diff√©rents formats (PDF, Excel, etc.)

2. **Tableaux de bord dynamiques avec TeeChart**
   - Graphiques de tendances
   - Analyses comparatives
   - Indicateurs cl√©s de performance (KPI)
   - Filtrage des donn√©es par p√©riode

3. **Interfaces utilisateur conviviales**
   - S√©lection de p√©riodes sophistiqu√©e
   - Navigation intuitive entre les rapports
   - Pr√©sentation visuelle des donn√©es
   - Options d'exportation et de partage

### Avantages pour les utilisateurs :

- **Analyse approfondie** : Compr√©hension d√©taill√©e des performances de l'entreprise
- **Prise de d√©cision √©clair√©e** : Informations pertinentes pour orienter les strat√©gies commerciales
- **Suivi des objectifs** : Possibilit√© de mesurer les r√©sultats par rapport aux objectifs fix√©s
- **Identification des tendances** : D√©tection des √©volutions positives ou n√©gatives
- **Communication efficace** : Partage des r√©sultats avec les parties prenantes

### Axes d'am√©lioration possibles :

Pour enrichir davantage votre syst√®me de rapports, vous pourriez envisager :

1. **Int√©gration de l'intelligence artificielle** : Analyse pr√©dictive des ventes futures
2. **Notifications automatiques** : Alertes lorsque certains indicateurs atteignent des seuils critiques
3. **Rapports personnalis√©s** : Permettre aux utilisateurs de cr√©er leurs propres rapports
4. **Tableaux de bord mobiles** : Adaptation pour consultation sur smartphones et tablettes
5. **Analyses g√©ographiques** : Cartographie des ventes par r√©gion

## Bonnes pratiques pour les rapports et tableaux de bord

Pour garantir l'efficacit√© de vos rapports et tableaux de bord, voici quelques recommandations :

### 1. Conception claire et accessible

```pascal
// Exemple de code pour am√©liorer la lisibilit√© d'un graphique
procedure TfrmDashboard.OptimizeChartReadability(AChart: TChart);
begin
  // Utiliser des couleurs contrast√©es
  AChart.SeriesList[0].Color := clNavy;
  AChart.SeriesList[1].Color := clRed;

  // Augmenter la taille des polices
  AChart.Title.Font.Size := 12;
  AChart.Title.Font.Style := [fsBold];
  AChart.Legend.Font.Size := 10;

  // Ajouter une grille pour faciliter la lecture
  AChart.LeftAxis.Grid.Visible := True;
  AChart.LeftAxis.Grid.Style := psDot;

  // Limiter le nombre d'√©tiquettes sur l'axe X pour √©viter l'encombrement
  if AChart.BottomAxis.Labels.Count > 10 then
    AChart.BottomAxis.LabelsAngle := 45;
end;
```

### 2. Performance optimis√©e

```pascal
// Exemple de code pour optimiser les requ√™tes de rapport
procedure TDataModuleReports.OptimizeReportQuery;
begin
  // Ajouter des index √† la base de donn√©es pour acc√©l√©rer les requ√™tes fr√©quentes
  with FDConnection.ExecSQL(
    'CREATE INDEX IF NOT EXISTS idx_commandes_date ON Commandes(DateCommande)') do;

  // Utiliser des vues pour les requ√™tes complexes fr√©quemment utilis√©es
  with FDConnection.ExecSQL(
    'CREATE OR REPLACE VIEW vw_ventes_mensuelles AS ' +
    'SELECT YEAR(DateCommande) AS Annee, MONTH(DateCommande) AS Mois, ' +
    'SUM(MontantTTC) AS TotalVentes, COUNT(*) AS NombreCommandes ' +
    'FROM Commandes ' +
    'WHERE Statut NOT IN (''Annul√©e'') ' +
    'GROUP BY YEAR(DateCommande), MONTH(DateCommande)') do;

  // Limiter le volume de donn√©es charg√©es en m√©moire
  qrySalesReport.FetchOptions.RowsetSize := 100;
end;
```

### 3. Interactivit√© et personnalisation

```pascal
// Exemple de code pour cr√©er un filtre de rapport interactif
procedure TfrmCustomReport.CreateInteractiveFilter;
var
  i: Integer;
begin
  // Cr√©er un panel pour les filtres
  pnlFilters := TPanel.Create(Self);
  pnlFilters.Parent := Self;
  pnlFilters.Align := alTop;
  pnlFilters.Height := 40;
  pnlFilters.BevelOuter := bvNone;

  // Ajouter une combobox pour filtrer par cat√©gorie
  cboFilterCategory := TComboBox.Create(pnlFilters);
  cboFilterCategory.Parent := pnlFilters;
  cboFilterCategory.Left := 10;
  cboFilterCategory.Top := 10;
  cboFilterCategory.Width := 150;
  cboFilterCategory.Style := csDropDownList;
  cboFilterCategory.Items.Add('Toutes les cat√©gories');

  // Charger les cat√©gories depuis la base de donn√©es
  dmBusiness.CategorieRepository.LoadCategoriesToCombo(cboFilterCategory);
  cboFilterCategory.ItemIndex := 0;
  cboFilterCategory.OnChange := FilterChanged;

  // Ajouter un contr√¥le de p√©riode
  dtpStart := TDateTimePicker.Create(pnlFilters);
  dtpStart.Parent := pnlFilters;
  dtpStart.Left := 180;
  dtpStart.Top := 10;
  dtpStart.Width := 100;
  dtpStart.Date := StartOfTheMonth(Date);
  dtpStart.OnChange := FilterChanged;

  lblTo := TLabel.Create(pnlFilters);
  lblTo.Parent := pnlFilters;
  lblTo.Left := 290;
  lblTo.Top := 14;
  lblTo.Caption := 'au';

  dtpEnd := TDateTimePicker.Create(pnlFilters);
  dtpEnd.Parent := pnlFilters;
  dtpEnd.Left := 310;
  dtpEnd.Top := 10;
  dtpEnd.Width := 100;
  dtpEnd.Date := EndOfTheMonth(Date);
  dtpEnd.OnChange := FilterChanged;

  // Ajouter un bouton d'application du filtre
  btnApplyFilter := TButton.Create(pnlFilters);
  btnApplyFilter.Parent := pnlFilters;
  btnApplyFilter.Left := 420;
  btnApplyFilter.Top := 8;
  btnApplyFilter.Width := 100;
  btnApplyFilter.Caption := 'Appliquer';
  btnApplyFilter.OnClick := ApplyFilterClick;
end;
```

### 4. Documentation et aide contextuelle

```pascal
// Exemple de code pour ajouter de l'aide contextuelle
procedure TfrmReport.AddContextualHelp;
begin
  // Cr√©er une ic√¥ne d'aide
  btnHelp := TSpeedButton.Create(Self);
  btnHelp.Parent := pnlTop;
  btnHelp.Align := alRight;
  btnHelp.Width := 25;
  btnHelp.Caption := '?';
  btnHelp.Font.Style := [fsBold];
  btnHelp.Flat := True;
  btnHelp.OnClick := HelpButtonClick;

  // Cr√©er des infobulles d√©taill√©es
  with cboDateRange do
  begin
    ShowHint := True;
    Hint := 'S√©lectionnez la p√©riode pour filtrer les donn√©es du rapport.' + #13#10 +
           'Les donn√©es seront automatiquement mises √† jour en fonction de votre choix.';
  end;

  with chartSales do
  begin
    ShowHint := True;
    Hint := 'Ce graphique pr√©sente l''√©volution des ventes sur la p√©riode s√©lectionn√©e.' + #13#10 +
           'Survolez les points pour voir les valeurs exactes.';
  end;
end;

procedure TfrmReport.HelpButtonClick(Sender: TObject);
begin
  // Afficher un dialogue d'aide
  with TTaskDialog.Create(Self) do
  try
    Caption := 'Aide sur les rapports';
    Title := 'Utilisation des rapports';
    Text := 'Ce rapport vous permet de visualiser et d''analyser vos donn√©es de vente.' + #13#10#13#10 +
           '1. Utilisez les filtres en haut pour s√©lectionner la p√©riode souhait√©e.' + #13#10 +
           '2. Les graphiques montrent l''√©volution des ventes et autres indicateurs cl√©s.' + #13#10 +
           '3. Vous pouvez exporter les donn√©es en PDF ou Excel via les boutons d√©di√©s.' + #13#10 +
           '4. Pour une analyse plus d√©taill√©e, utilisez les tableaux de bord interactifs.';
    CommonButtons := [tcbClose];
    MainIcon := tdiInformation;
    Execute;
  finally
    Free;
  end;
end;
```

### 5. Exportation et partage des rapports

```pascal
// Exemple de code pour exporter un rapport avec param√®tres avanc√©s
procedure TfrmReport.ExportReportWithAdvancedOptions;
var
  ExportDialog: TForm;
  cboPdfQuality, cboExcelFormat: TComboBox;
  chkIncludeCharts, chkIncludeHeaders: TCheckBox;
  btnExport, btnCancel: TButton;
begin
  // Cr√©er une bo√Æte de dialogue d'options d'exportation
  ExportDialog := TForm.Create(nil);
  try
    ExportDialog.Caption := 'Options d''exportation';
    ExportDialog.Width := 400;
    ExportDialog.Height := 300;
    ExportDialog.Position := poScreenCenter;
    ExportDialog.BorderStyle := bsDialog;

    // Ajouter les contr√¥les pour les options
    with TLabel.Create(ExportDialog) do
    begin
      Parent := ExportDialog;
      Left := 20;
      Top := 20;
      Caption := 'Format d''exportation :';
    end;

    cboPdfQuality := TComboBox.Create(ExportDialog);
    cboPdfQuality.Parent := ExportDialog;
    cboPdfQuality.Left := 150;
    cboPdfQuality.Top := 20;
    cboPdfQuality.Width := 200;
    cboPdfQuality.Style := csDropDownList;
    cboPdfQuality.Items.Add('PDF - Qualit√© standard');
    cboPdfQuality.Items.Add('PDF - Haute qualit√©');
    cboPdfQuality.Items.Add('PDF - Optimis√© pour impression');
    cboPdfQuality.Items.Add('Excel - Format moderne (XLSX)');
    cboPdfQuality.Items.Add('Excel - Format compatible (XLS)');
    cboPdfQuality.Items.Add('Word - Document (DOCX)');
    cboPdfQuality.ItemIndex := 0;

    chkIncludeCharts := TCheckBox.Create(ExportDialog);
    chkIncludeCharts.Parent := ExportDialog;
    chkIncludeCharts.Left := 20;
    chkIncludeCharts.Top := 60;
    chkIncludeCharts.Width := 350;
    chkIncludeCharts.Caption := 'Inclure les graphiques';
    chkIncludeCharts.Checked := True;

    chkIncludeHeaders := TCheckBox.Create(ExportDialog);
    chkIncludeHeaders.Parent := ExportDialog;
    chkIncludeHeaders.Left := 20;
    chkIncludeHeaders.Top := 90;
    chkIncludeHeaders.Width := 350;
    chkIncludeHeaders.Caption := 'Inclure les en-t√™tes et pieds de page';
    chkIncludeHeaders.Checked := True;

    // Ajouter les boutons
    btnExport := TButton.Create(ExportDialog);
    btnExport.Parent := ExportDialog;
    btnExport.Caption := 'Exporter';
    btnExport.Left := 200;
    btnExport.Top := 220;
    btnExport.Width := 80;
    btnExport.Default := True;
    btnExport.ModalResult := mrOk;

    btnCancel := TButton.Create(ExportDialog);
    btnCancel.Parent := ExportDialog;
    btnCancel.Caption := 'Annuler';
    btnCancel.Left := 290;
    btnCancel.Top := 220;
    btnCancel.Width := 80;
    btnCancel.Cancel := True;
    btnCancel.ModalResult := mrCancel;

    // Afficher la bo√Æte de dialogue
    if ExportDialog.ShowModal = mrOk then
    begin
      // Exporter selon les options choisies
      case cboPdfQuality.ItemIndex of
        0, 1, 2: ExportToPdf(cboPdfQuality.ItemIndex, chkIncludeCharts.Checked);
        3, 4: ExportToExcel(cboPdfQuality.ItemIndex - 3, chkIncludeCharts.Checked);
        5: ExportToWord(chkIncludeCharts.Checked);
      end;
    end;
  finally
    ExportDialog.Free;
  end;
end;
```

## Exercices pratiques

Pour mettre en pratique les concepts abord√©s dans cette section, voici quelques exercices :

1. **Rapport de rentabilit√©** : Cr√©ez un rapport qui analyse la rentabilit√© par produit, en calculant la marge brute et le taux de marge.

2. **Tableau de bord clients** : D√©veloppez un tableau de bord qui montre l'√©volution du nombre de clients, leur fid√©lit√© (nombre de commandes par client) et la valeur client (montant moyen d√©pens√©).

3. **Rapport de stocks critiques** : Cr√©ez un rapport qui identifie les produits dont le stock est inf√©rieur au seuil minimal, avec des alertes visuelles.

4. **Analyse des produits les plus vendus** : D√©veloppez un graphique interactif permettant de visualiser les produits les plus vendus par cat√©gorie et p√©riode.

5. **Export automatis√© de rapports** : Impl√©mentez une fonctionnalit√© qui g√©n√®re et envoie automatiquement par email des rapports hebdomadaires aux responsables.

## Conseils pour des rapports efficaces

1. **Simplicit√© avant tout** : Privil√©giez la clart√© et la simplicit√© plut√¥t que des graphiques complexes ou surcharg√©s.

2. **Contexte et comparaisons** : Incluez toujours des points de r√©f√©rence (p√©riode pr√©c√©dente, objectifs) pour donner du contexte aux chiffres.

3. **Coh√©rence visuelle** : Utilisez une charte graphique coh√©rente (couleurs, polices, styles) pour tous vos rapports.

4. **Focus sur l'action** : Assurez-vous que chaque rapport ou tableau de bord conduit √† des actions concr√®tes.

5. **Retours utilisateurs** : Sollicitez r√©guli√®rement l'avis des utilisateurs pour am√©liorer vos rapports.

## Conclusion

Les rapports et tableaux de bord sont essentiels pour transformer vos donn√©es brutes en informations exploitables. Gr√¢ce √† Delphi et ses composants, vous pouvez cr√©er des outils d'analyse puissants et personnalis√©s qui aideront votre entreprise √† prendre des d√©cisions √©clair√©es.

Dans cette section, vous avez appris √† utiliser FastReport pour cr√©er des rapports statiques, TeeChart pour d√©velopper des visualisations graphiques, et √† impl√©menter des tableaux de bord interactifs. Vous avez √©galement d√©couvert comment personnaliser l'exp√©rience utilisateur et optimiser les performances de vos rapports.

En int√©grant ces fonctionnalit√©s √† votre application de gestion MySQL/MariaDB, vous offrez une valeur ajout√©e significative √† vos utilisateurs et transformez votre logiciel en un v√©ritable outil d'aide √† la d√©cision.

Dans la prochaine section, nous ferons la synth√®se de tout ce que nous avons appris pour finaliser notre application de gestion compl√®te et pr√©parer son d√©ploiement.

---

*Note : Les exemples de code pr√©sent√©s dans cette section peuvent n√©cessiter des ajustements selon votre environnement sp√©cifique et la structure exacte de votre base de donn√©es.*

‚è≠Ô∏è [Application multi-plateformes avec FMX](/19-projets-avances/02-application-multi-plateformes-avec-fmx.md)
