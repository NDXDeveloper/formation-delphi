# 19.1.4 Rapports et tableaux de bord

Dans cette section, nous allons apprendre à créer des rapports professionnels et des tableaux de bord interactifs pour notre application de gestion. Ces outils sont essentiels pour analyser les données, prendre des décisions éclairées et présenter l'information de manière claire aux utilisateurs.

## Pourquoi intégrer des rapports et tableaux de bord ?

Les rapports et tableaux de bord jouent un rôle crucial dans toute application de gestion :

- **Visualisation des données** : transformer des chiffres bruts en graphiques faciles à comprendre
- **Aide à la décision** : identifier les tendances, les points forts et les problèmes
- **Communication** : partager facilement l'information avec les parties prenantes
- **Suivi des performances** : mesurer l'activité par rapport aux objectifs
- **Documentation** : conserver un historique des activités

## Architecture des rapports dans notre application

Nous allons implémenter deux approches complémentaires :

1. **Rapports statiques** : documents formatés pouvant être imprimés ou exportés
2. **Tableaux de bord dynamiques** : interfaces interactives permettant d'explorer les données

![Architecture des rapports](https://via.placeholder.com/800x400)

## Utilisation de FastReport pour les rapports

FastReport est l'un des outils de reporting les plus populaires pour Delphi. Dans ce tutoriel, nous utiliserons sa version Community Edition qui est gratuite.

> **Note** : Si vous n'avez pas FastReport installé, vous pouvez l'obtenir via GetIt Package Manager dans Delphi. Allez dans Outils > GetIt Package Manager, recherchez "FastReport" et installez la version communautaire.

### Installation de FastReport VCL

1. Dans Delphi, sélectionnez **Outils > GetIt Package Manager**
2. Dans la barre de recherche, tapez "FastReport"
3. Trouvez "FastReport VCL Community Edition" et cliquez sur "Install"
4. Suivez les instructions d'installation
5. Redémarrez Delphi pour terminer l'installation

### Création d'un rapport de ventes simple

Commençons par créer un rapport de ventes basique :

1. Ajoutez un nouveau Data Module à votre projet et nommez-le `dmReports`
2. Ajoutez un composant `TFDQuery` et configurez-le pour extraire les données des ventes
3. Ajoutez un composant `TfrxReport` et un `TfrxDBDataset` depuis la palette FastReport
4. Liez le `TfrxDBDataset` à votre query

Voici le code pour configurer le module de données :

```pascal
unit dmReports;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, frxClass, frxDBSet,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, dmDatabase;

type
  TDataModuleReports = class(TDataModule)
    qrySalesReport: TFDQuery;
    frxReport1: TfrxReport;
    frxDBDataset1: TfrxDBDataset;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Déclarations privées }
  public
    { Déclarations publiques }
    procedure PrepareSalesReport(const AStartDate, AEndDate: TDateTime);
    procedure ShowSalesReport;
  end;

var
  DataModuleReports: TDataModuleReports;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

{$R *.dfm}

procedure TDataModuleReports.DataModuleCreate(Sender: TObject);
begin
  // Configurer le dataset FastReport
  frxDBDataset1.DataSet := qrySalesReport;

  // Charger le fichier de rapport s'il existe
  if FileExists(ExtractFilePath(ParamStr(0)) + 'Reports\SalesReport.fr3') then
    frxReport1.LoadFromFile(ExtractFilePath(ParamStr(0)) + 'Reports\SalesReport.fr3');
end;

procedure TDataModuleReports.PrepareSalesReport(const AStartDate, AEndDate: TDateTime);
begin
  // Configurer la requête
  qrySalesReport.Close;
  qrySalesReport.SQL.Text :=
    'SELECT c.CommandeID, c.Reference, c.DateCommande, ' +
    'cl.Nom AS NomClient, cl.Prenom AS PrenomClient, ' +
    'SUM(l.Quantite * l.PrixUnitaire * (1 - l.Remise / 100)) AS MontantHT, ' +
    'c.MontantTTC, c.Statut ' +
    'FROM Commandes c ' +
    'JOIN Clients cl ON c.ClientID = cl.ClientID ' +
    'JOIN LignesCommande l ON c.CommandeID = l.CommandeID ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'GROUP BY c.CommandeID ' +
    'ORDER BY c.DateCommande DESC';

  qrySalesReport.ParamByName('DateDebut').AsDate := AStartDate;
  qrySalesReport.ParamByName('DateFin').AsDate := AEndDate;
  qrySalesReport.Open;
end;

procedure TDataModuleReports.ShowSalesReport;
begin
  // Vérifier que les données sont disponibles
  if qrySalesReport.IsEmpty then
  begin
    ShowMessage('Aucune donnée disponible pour cette période.');
    Exit;
  end;

  // Afficher l'aperçu du rapport
  frxReport1.ShowReport;
end;

end.
```

### Conception du rapport avec l'éditeur FastReport

Maintenant que notre module de données est configuré, nous allons concevoir le rapport :

1. Double-cliquez sur le composant `frxReport1` pour ouvrir l'éditeur FastReport
2. Dans l'éditeur, allez dans le menu **Rapport > Données...**
3. Vérifiez que votre `frxDBDataset1` est disponible
4. Cliquez sur **OK** pour retourner à l'éditeur
5. Ajoutez les bandes nécessaires : Report Title, Page Header, Master Data, Page Footer
6. Glissez-déposez les champs de données sur la bande Master Data
7. Ajoutez des titres, des logos et le formatage souhaité
8. Enregistrez le rapport sous "SalesReport.fr3" dans un dossier "Reports"

![Éditeur FastReport](https://via.placeholder.com/800x600)

### Création d'un formulaire pour générer les rapports

Maintenant, créons un formulaire qui permettra à l'utilisateur de sélectionner la période et de générer le rapport :

```pascal
unit FormSalesReport;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.ComCtrls, Vcl.Buttons, dmReports;

type
  TfrmSalesReport = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlParams: TPanel;
    lblPeriod: TLabel;
    dtpStart: TDateTimePicker;
    dtpEnd: TDateTimePicker;
    lblTo: TLabel;
    pnlButtons: TPanel;
    btnGenerate: TButton;
    btnClose: TButton;
    rbCurrentMonth: TRadioButton;
    rbLastMonth: TRadioButton;
    rbCustomPeriod: TRadioButton;
    procedure FormCreate(Sender: TObject);
    procedure rbCurrentMonthClick(Sender: TObject);
    procedure rbLastMonthClick(Sender: TObject);
    procedure rbCustomPeriodClick(Sender: TObject);
    procedure btnGenerateClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { Déclarations privées }
    procedure UpdateDatePickers;
  public
    { Déclarations publiques }
  end;

var
  frmSalesReport: TfrmSalesReport;

implementation

{$R *.dfm}

procedure TfrmSalesReport.FormCreate(Sender: TObject);
begin
  // Par défaut, sélectionner le mois courant
  rbCurrentMonth.Checked := True;
  UpdateDatePickers;
end;

procedure TfrmSalesReport.UpdateDatePickers;
var
  Y, M, D: Word;
  FirstDay, LastDay: TDateTime;
begin
  if rbCurrentMonth.Checked then
  begin
    // Mois courant
    DecodeDate(Date, Y, M, D);
    FirstDay := EncodeDate(Y, M, 1);
    LastDay := IncMonth(FirstDay, 1) - 1;

    dtpStart.Date := FirstDay;
    dtpEnd.Date := LastDay;

    dtpStart.Enabled := False;
    dtpEnd.Enabled := False;
  end
  else if rbLastMonth.Checked then
  begin
    // Mois précédent
    DecodeDate(IncMonth(Date, -1), Y, M, D);
    FirstDay := EncodeDate(Y, M, 1);
    LastDay := IncMonth(FirstDay, 1) - 1;

    dtpStart.Date := FirstDay;
    dtpEnd.Date := LastDay;

    dtpStart.Enabled := False;
    dtpEnd.Enabled := False;
  end
  else if rbCustomPeriod.Checked then
  begin
    // Période personnalisée
    dtpStart.Enabled := True;
    dtpEnd.Enabled := True;
  end;
end;

procedure TfrmSalesReport.rbCurrentMonthClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.rbLastMonthClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.rbCustomPeriodClick(Sender: TObject);
begin
  UpdateDatePickers;
end;

procedure TfrmSalesReport.btnGenerateClick(Sender: TObject);
begin
  // Vérifier les dates
  if dtpStart.Date > dtpEnd.Date then
  begin
    ShowMessage('La date de début doit être antérieure à la date de fin.');
    Exit;
  end;

  // Préparer et afficher le rapport
  DataModuleReports.PrepareSalesReport(dtpStart.Date, dtpEnd.Date);
  DataModuleReports.ShowSalesReport;
end;

procedure TfrmSalesReport.btnCloseClick(Sender: TObject);
begin
  Close;
end;

end.
```

### Exportation des rapports dans différents formats

FastReport permet d'exporter vos rapports dans plusieurs formats tels que PDF, Excel, Word, etc. Ajoutons cette fonctionnalité :

```pascal
procedure TDataModuleReports.ExportSalesReportToPDF(const AFileName: string);
begin
  if qrySalesReport.IsEmpty then
  begin
    ShowMessage('Aucune donnée disponible pour cette période.');
    Exit;
  end;

  // Configurer l'export PDF
  if frxReport1.PrepareReport then
  begin
    // Vérifier si le composant d'export est disponible
    if frxPDFExport1 = nil then
    begin
      frxPDFExport1 := TfrxPDFExport.Create(Self);
      frxPDFExport1.ShowDialog := False;
      frxPDFExport1.Background := True;
      frxPDFExport1.ShowProgress := False;
    end;

    // Configurer l'export
    frxPDFExport1.FileName := AFileName;
    frxPDFExport1.DefaultPath := ExtractFilePath(AFileName);

    // Exporter
    if frxReport1.Export(frxPDFExport1) then
      ShowMessage('Le rapport a été exporté avec succès : ' + AFileName);
  end;
end;
```

## Création d'un tableau de bord avec TeeChart

TeeChart est une bibliothèque de graphiques intégrée à Delphi. Utilisons-la pour créer un tableau de bord.

> **Note** : Si vous utilisez Delphi 11 ou 12, TeeChart est déjà inclus. Pour les versions antérieures, vous devrez peut-être l'installer séparément.

### Création d'un formulaire de tableau de bord

Commençons par créer un formulaire pour notre tableau de bord :

```pascal
unit FormDashboard;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.ComCtrls, VclTee.TeeGDIPlus, VclTee.TeEngine, VclTee.TeeProcs, VclTee.Chart,
  VclTee.Series, Data.DB, FireDAC.Comp.Client, dmDatabase;

type
  TfrmDashboard = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    cboDateRange: TComboBox;
    lblDateRange: TLabel;
    pnlMain: TPanel;
    splHorizontal: TSplitter;
    pnlTop50: TPanel;
    pnlBottom50: TPanel;
    splVertical: TSplitter;
    pnlBottomLeft: TPanel;
    pnlBottomRight: TPanel;
    chartSales: TChart;
    seriesSales: TBarSeries;
    chartTopProducts: TChart;
    seriesTopProducts: TPieSeries;
    chartCustomers: TChart;
    seriesCustomers: TLineSeries;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure cboDateRangeChange(Sender: TObject);
  private
    { Déclarations privées }
    FSalesQuery: TFDQuery;
    FTopProductsQuery: TFDQuery;
    FCustomersQuery: TFDQuery;

    procedure InitializeCharts;
    procedure LoadSalesData;
    procedure LoadTopProductsData;
    procedure LoadCustomersData;
    procedure LoadDashboardData;
  public
    { Déclarations publiques }
  end;

var
  frmDashboard: TfrmDashboard;

implementation

{$R *.dfm}

procedure TfrmDashboard.FormCreate(Sender: TObject);
begin
  // Créer les requêtes
  FSalesQuery := TFDQuery.Create(Self);
  FSalesQuery.Connection := DataModuleDB.FDConnection;

  FTopProductsQuery := TFDQuery.Create(Self);
  FTopProductsQuery.Connection := DataModuleDB.FDConnection;

  FCustomersQuery := TFDQuery.Create(Self);
  FCustomersQuery.Connection := DataModuleDB.FDConnection;

  // Initialiser les graphiques
  InitializeCharts;

  // Remplir la combobox des périodes
  cboDateRange.Items.Clear;
  cboDateRange.Items.Add('7 derniers jours');
  cboDateRange.Items.Add('30 derniers jours');
  cboDateRange.Items.Add('Ce mois-ci');
  cboDateRange.Items.Add('Ce trimestre');
  cboDateRange.Items.Add('Cette année');
  cboDateRange.ItemIndex := 2; // Ce mois-ci par défaut

  // Charger les données
  LoadDashboardData;
end;

procedure TfrmDashboard.FormDestroy(Sender: TObject);
begin
  FSalesQuery.Free;
  FTopProductsQuery.Free;
  FCustomersQuery.Free;
end;

procedure TfrmDashboard.InitializeCharts;
begin
  // Configurer le graphique des ventes
  with chartSales do
  begin
    Title.Text.Clear;
    Title.Text.Add('Évolution des ventes');
    Legend.Visible := False;
    Gradient.Visible := True;
    View3D := False;
  end;

  // Configurer le graphique des produits
  with chartTopProducts do
  begin
    Title.Text.Clear;
    Title.Text.Add('Top 5 des produits');
    Legend.Visible := True;
    Gradient.Visible := True;
    View3D := True;
  end;

  // Configurer le graphique des clients
  with chartCustomers do
  begin
    Title.Text.Clear;
    Title.Text.Add('Nouveaux clients');
    Legend.Visible := False;
    Gradient.Visible := True;
    View3D := False;
  end;
end;

procedure TfrmDashboard.LoadDashboardData;
begin
  Screen.Cursor := crHourGlass;
  try
    LoadSalesData;
    LoadTopProductsData;
    LoadCustomersData;
  finally
    Screen.Cursor := crDefault;
  end;
end;

procedure TfrmDashboard.LoadSalesData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
  DateFormat: string;
  GroupBy: string;
begin
  // Déterminer la période
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        StartDate := Date - 6;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    1: // 30 derniers jours
      begin
        StartDate := Date - 29;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    2: // Ce mois-ci
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
    3: // Ce trimestre
      begin
        StartDate := StartOfTheQuarter(Date);
        EndDate := EndOfTheQuarter(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
      end;
    4: // Cette année
      begin
        StartDate := StartOfTheYear(Date);
        EndDate := EndOfTheYear(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
      end;
    else
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(c.DateCommande AS DATE)';
      end;
  end;

  // Construire la requête SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroupe, ' +
    'DATE_FORMAT(c.DateCommande, ''%s'') AS DateAffichage, ' +
    'SUM(c.MontantTTC) AS TotalVentes ' +
    'FROM Commandes c ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annulée'') ' +
    'GROUP BY DateGroupe ' +
    'ORDER BY DateGroupe';

  SQL := Format(SQL, [DateFormat]);

  // Exécuter la requête
  FSalesQuery.Close;
  FSalesQuery.SQL.Text := SQL;
  FSalesQuery.ParamByName('DateDebut').AsDate := StartDate;
  FSalesQuery.ParamByName('DateFin').AsDate := EndDate;
  FSalesQuery.Open;

  // Effacer le graphique
  seriesSales.Clear;

  // Remplir le graphique
  while not FSalesQuery.Eof do
  begin
    seriesSales.Add(
      FSalesQuery.FieldByName('TotalVentes').AsFloat,
      FSalesQuery.FieldByName('DateAffichage').AsString
    );
    FSalesQuery.Next;
  end;
end;

procedure TfrmDashboard.LoadTopProductsData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
begin
  // Déterminer la période
  case cboDateRange.ItemIndex of
    0: StartDate := Date - 6; // 7 derniers jours
    1: StartDate := Date - 29; // 30 derniers jours
    2: StartDate := StartOfTheMonth(Date); // Ce mois-ci
    3: StartDate := StartOfTheQuarter(Date); // Ce trimestre
    4: StartDate := StartOfTheYear(Date); // Cette année
    else StartDate := StartOfTheMonth(Date);
  end;
  EndDate := Date;

  // Construire la requête SQL
  SQL :=
    'SELECT p.Designation, SUM(l.Quantite) AS TotalVendus, ' +
    'SUM(l.Quantite * l.PrixUnitaire * (1 - l.Remise / 100)) AS MontantTotal ' +
    'FROM LignesCommande l ' +
    'JOIN Produits p ON l.ProduitID = p.ProduitID ' +
    'JOIN Commandes c ON l.CommandeID = c.CommandeID ' +
    'WHERE c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annulée'') ' +
    'GROUP BY p.ProduitID ' +
    'ORDER BY TotalVendus DESC ' +
    'LIMIT 5';

  // Exécuter la requête
  FTopProductsQuery.Close;
  FTopProductsQuery.SQL.Text := SQL;
  FTopProductsQuery.ParamByName('DateDebut').AsDate := StartDate;
  FTopProductsQuery.ParamByName('DateFin').AsDate := EndDate;
  FTopProductsQuery.Open;

  // Effacer le graphique
  seriesTopProducts.Clear;

  // Remplir le graphique
  while not FTopProductsQuery.Eof do
  begin
    seriesTopProducts.Add(
      FTopProductsQuery.FieldByName('TotalVendus').AsFloat,
      FTopProductsQuery.FieldByName('Designation').AsString,
      clRandom
    );
    FTopProductsQuery.Next;
  end;
end;

procedure TfrmDashboard.LoadCustomersData;
var
  SQL: string;
  StartDate, EndDate: TDateTime;
  DateFormat: string;
  GroupBy: string;
begin
  // Déterminer la période
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        StartDate := Date - 6;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    1: // 30 derniers jours
      begin
        StartDate := Date - 29;
        EndDate := Date;
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    2: // Ce mois-ci
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
    3: // Ce trimestre
      begin
        StartDate := StartOfTheQuarter(Date);
        EndDate := EndOfTheQuarter(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(DateCreation), MONTH(DateCreation)';
      end;
    4: // Cette année
      begin
        StartDate := StartOfTheYear(Date);
        EndDate := EndOfTheYear(Date);
        DateFormat := 'mm/yyyy';
        GroupBy := 'YEAR(DateCreation), MONTH(DateCreation)';
      end;
    else
      begin
        StartDate := StartOfTheMonth(Date);
        EndDate := EndOfTheMonth(Date);
        DateFormat := 'dd/mm';
        GroupBy := 'CAST(DateCreation AS DATE)';
      end;
  end;

  // Construire la requête SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroupe, ' +
    'DATE_FORMAT(DateCreation, ''%s'') AS DateAffichage, ' +
    'COUNT(*) AS NouveauxClients ' +
    'FROM Clients ' +
    'WHERE DateCreation BETWEEN :DateDebut AND :DateFin ' +
    'GROUP BY DateGroupe ' +
    'ORDER BY DateGroupe';

  SQL := Format(SQL, [DateFormat]);

  // Exécuter la requête
  FCustomersQuery.Close;
  FCustomersQuery.SQL.Text := SQL;
  FCustomersQuery.ParamByName('DateDebut').AsDate := StartDate;
  FCustomersQuery.ParamByName('DateFin').AsDate := EndDate;
  FCustomersQuery.Open;

  // Effacer le graphique
  seriesCustomers.Clear;

  // Remplir le graphique
  while not FCustomersQuery.Eof do
  begin
    seriesCustomers.AddXY(
      seriesCustomers.Count + 1,
      FCustomersQuery.FieldByName('NouveauxClients').AsFloat,
      FCustomersQuery.FieldByName('DateAffichage').AsString
    );
    FCustomersQuery.Next;
  end;
end;

procedure TfrmDashboard.cboDateRangeChange(Sender: TObject);
begin
  LoadDashboardData;
end;

// Fonctions utilitaires pour les dates
function StartOfTheMonth(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, M, 1);
end;

function EndOfTheMonth(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, M, 1) + 32;
  DecodeDate(Result, Y, M, D);
  Result := EncodeDate(Y, M, 1) - 1;
end;

function StartOfTheQuarter(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
  QuarterMonth: Integer;
begin
  DecodeDate(ADate, Y, M, D);
  QuarterMonth := ((M - 1) div 3) * 3 + 1;
  Result := EncodeDate(Y, QuarterMonth, 1);
end;

function EndOfTheQuarter(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
  QuarterMonth: Integer;
begin
  DecodeDate(ADate, Y, M, D);
  QuarterMonth := ((M - 1) div 3) * 3 + 3;
  Result := EncodeDate(Y, QuarterMonth, 1);
  Result := IncMonth(Result, 1) - 1;
end;

function StartOfTheYear(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, 1, 1);
end;

function EndOfTheYear(const ADate: TDateTime): TDateTime;
var
  Y, M, D: Word;
begin
  DecodeDate(ADate, Y, M, D);
  Result := EncodeDate(Y, 12, 31);
end;

end.
```

### Création d'un rapport d'inventaire

Maintenant, créons un rapport d'inventaire pour suivre les niveaux de stock :

```pascal
procedure TDataModuleReports.PrepareInventoryReport;
begin
  // Configurer la requête
  qryInventoryReport.Close;
  qryInventoryReport.SQL.Text :=
    'SELECT p.ProduitID, p.Reference, p.Designation, c.NomCategorie, ' +
    'f.RaisonSociale AS NomFournisseur, p.PrixAchat, p.PrixVente, ' +
    's.QuantiteDisponible, s.StockMinimum, ' +
    'CASE WHEN s.QuantiteDisponible <= 0 THEN ''Rupture'' ' +
    '     WHEN s.QuantiteDisponible < s.StockMinimum THEN ''Faible'' ' +
    '     ELSE ''Normal'' END AS StatutStock ' +
    'FROM Produits p ' +
    'LEFT JOIN Categories c ON p.CategoryID = c.CategoryID ' +
    'LEFT JOIN Fournisseurs f ON p.FournisseurID = f.FournisseurID ' +
    'LEFT JOIN Stock s ON p.ProduitID = s.ProduitID ' +
    'WHERE p.Actif = TRUE ' +
    'ORDER BY StatutStock, c.NomCategorie, p.Designation';

  qryInventoryReport.Open;
end;

procedure TDataModuleReports.ShowInventoryReport;
begin
  // Vérifier que les données sont disponibles
  if qryInventoryReport.IsEmpty then
  begin
    ShowMessage('Aucune donnée d''inventaire disponible.');
    Exit;
  end;

  // Afficher l'aperçu du rapport
  frxReportInventory.ShowReport;
end;
```

## Création d'un rapport d'analyse des ventes par période

Un rapport d'analyse des ventes est essentiel pour comprendre les performances commerciales. Implémentons cette fonctionnalité :

```pascal
procedure TDataModuleReports.PrepareSalesByPeriodReport(const APeriodType: string);
var
  SQL, GroupBy, DateFormat: string;
begin
  // Définir le format et le regroupement en fonction de la période
  if APeriodType = 'DAY' then
  begin
    GroupBy := 'CAST(c.DateCommande AS DATE)';
    DateFormat := '%d/%m/%Y';
  end
  else if APeriodType = 'WEEK' then
  begin
    GroupBy := 'YEARWEEK(c.DateCommande, 1)';
    DateFormat := 'Semaine %v %Y';
  end
  else if APeriodType = 'MONTH' then
  begin
    GroupBy := 'YEAR(c.DateCommande), MONTH(c.DateCommande)';
    DateFormat := '%m/%Y';
  end
  else if APeriodType = 'QUARTER' then
  begin
    GroupBy := 'YEAR(c.DateCommande), QUARTER(c.DateCommande)';
    DateFormat := 'Q%q %Y';
  end
  else // YEAR
  begin
    GroupBy := 'YEAR(c.DateCommande)';
    DateFormat := '%Y';
  end;

  // Construire la requête SQL
  SQL :=
    'SELECT ' + GroupBy + ' AS Periode, ' +
    'DATE_FORMAT(MIN(c.DateCommande), ''' + DateFormat + ''') AS PeriodeAffichage, ' +
    'COUNT(DISTINCT c.CommandeID) AS NombreCommandes, ' +
    'SUM(c.MontantHT) AS TotalHT, ' +
    'SUM(c.MontantTTC - c.MontantHT) AS TotalTVA, ' +
    'SUM(c.MontantTTC) AS TotalTTC, ' +
    'AVG(c.MontantTTC) AS PanierMoyen ' +
    'FROM Commandes c ' +
    'WHERE c.Statut NOT IN (''Annulée'') ' +
    'GROUP BY Periode ' +
    'ORDER BY MIN(c.DateCommande) DESC';

  // Exécuter la requête
  qrySalesByPeriod.Close;
  qrySalesByPeriod.SQL.Text := SQL;
  qrySalesByPeriod.Open;

  // Stocker le type de période pour le titre du rapport
  qrySalesByPeriod.FieldByName('PeriodeType').AsString := APeriodType;
end;

procedure TDataModuleReports.ShowSalesByPeriodReport;
begin
  // Vérifier que les données sont disponibles
  if qrySalesByPeriod.IsEmpty then
  begin
    ShowMessage('Aucune donnée de ventes disponible.');
    Exit;
  end;

  // Afficher l'aperçu du rapport
  frxReportSalesByPeriod.ShowReport;
end;
```

## Création d'un formulaire de sélection de période avancé

Pour permettre à l'utilisateur de sélectionner précisément la période qu'il souhaite analyser, créons un formulaire plus sophistiqué :

```pascal
unit FormReportPeriod;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.ComCtrls, Vcl.Buttons;

type
  TReportPeriodType = (rptDay, rptWeek, rptMonth, rptQuarter, rptYear, rptCustom);

  TfrmReportPeriod = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlPeriodType: TPanel;
    rbDay: TRadioButton;
    rbWeek: TRadioButton;
    rbMonth: TRadioButton;
    rbQuarter: TRadioButton;
    rbYear: TRadioButton;
    rbCustom: TRadioButton;
    pnlPredefined: TPanel;
    cboPredefined: TComboBox;
    lblPredefined: TLabel;
    pnlCustom: TPanel;
    lblStartDate: TLabel;
    dtpStartDate: TDateTimePicker;
    lblEndDate: TLabel;
    dtpEndDate: TDateTimePicker;
    pnlBottom: TPanel;
    btnGenerate: TButton;
    btnCancel: TButton;
    procedure FormCreate(Sender: TObject);
    procedure rbDayClick(Sender: TObject);
    procedure rbWeekClick(Sender: TObject);
    procedure rbMonthClick(Sender: TObject);
    procedure rbQuarterClick(Sender: TObject);
    procedure rbYearClick(Sender: TObject);
    procedure rbCustomClick(Sender: TObject);
    procedure cboPredefinedChange(Sender: TObject);
    procedure btnGenerateClick(Sender: TObject);
    procedure btnCancelClick(Sender: TObject);
  private
    { Déclarations privées }
    FPeriodType: TReportPeriodType;
    FStartDate: TDateTime;
    FEndDate: TDateTime;

    procedure UpdateControls;
    procedure UpdatePredefinedList;
    procedure UpdateDates;
  public
    { Déclarations publiques }
    property PeriodType: TReportPeriodType read FPeriodType;
    property StartDate: TDateTime read FStartDate;
    property EndDate: TDateTime read FEndDate;

    function GetPeriodTypeString: string;
  end;

var
  frmReportPeriod: TfrmReportPeriod;

implementation

{$R *.dfm}

procedure TfrmReportPeriod.FormCreate(Sender: TObject);
begin
  // Valeurs par défaut
  FPeriodType := rptMonth;
  rbMonth.Checked := True;

  // Initialiser les contrôles
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.UpdateControls;
begin
  // Activer/désactiver les contrôles selon le type de période
  pnlPredefined.Visible := FPeriodType <> rptCustom;
  pnlCustom.Visible := FPeriodType = rptCustom;

  // Configurer le DateTimePicker selon la période
  case FPeriodType of
    rptDay:
      begin
        dtpStartDate.Format := 'dd/MM/yyyy';
        dtpEndDate.Format := 'dd/MM/yyyy';
      end;
    rptWeek, rptMonth, rptQuarter, rptYear:
      begin
        dtpStartDate.Format := 'MMMM yyyy';
        dtpEndDate.Format := 'MMMM yyyy';
      end;
    rptCustom:
      begin
        dtpStartDate.Format := 'dd/MM/yyyy';
        dtpEndDate.Format := 'dd/MM/yyyy';
      end;
  end;
end;

procedure TfrmReportPeriod.UpdatePredefinedList;
begin
  cboPredefined.Items.Clear;

  case FPeriodType of
    rptDay:
      begin
        cboPredefined.Items.Add('Aujourd''hui');
        cboPredefined.Items.Add('Hier');
        cboPredefined.Items.Add('7 derniers jours');
        cboPredefined.Items.Add('30 derniers jours');
      end;
    rptWeek:
      begin
        cboPredefined.Items.Add('Cette semaine');
        cboPredefined.Items.Add('Semaine dernière');
        cboPredefined.Items.Add('4 dernières semaines');
        cboPredefined.Items.Add('13 dernières semaines');
      end;
    rptMonth:
      begin
        cboPredefined.Items.Add('Ce mois-ci');
        cboPredefined.Items.Add('Mois dernier');
        cboPredefined.Items.Add('3 derniers mois');
        cboPredefined.Items.Add('6 derniers mois');
        cboPredefined.Items.Add('12 derniers mois');
      end;
    rptQuarter:
      begin
        cboPredefined.Items.Add('Ce trimestre');
        cboPredefined.Items.Add('Trimestre dernier');
        cboPredefined.Items.Add('4 derniers trimestres');
      end;
    rptYear:
      begin
        cboPredefined.Items.Add('Cette année');
        cboPredefined.Items.Add('Année dernière');
        cboPredefined.Items.Add('3 dernières années');
        cboPredefined.Items.Add('5 dernières années');
      end;
  end;

  // Sélectionner le premier élément
  if cboPredefined.Items.Count > 0 then
    cboPredefined.ItemIndex := 0;
end;

procedure TfrmReportPeriod.UpdateDates;
var
  Y, M, D: Word;
  FirstDayOfWeek: Integer;
begin
  // Calculer les dates en fonction du type de période et de l'élément sélectionné
  case FPeriodType of
    rptDay:
      case cboPredefined.ItemIndex of
        0: // Aujourd'hui
          begin
            FStartDate := Date;
            FEndDate := Date;
          end;
        1: // Hier
          begin
            FStartDate := Date - 1;
            FEndDate := Date - 1;
          end;
        2: // 7 derniers jours
          begin
            FStartDate := Date - 6;
            FEndDate := Date;
          end;
        3: // 30 derniers jours
          begin
            FStartDate := Date - 29;
            FEndDate := Date;
          end;
      end;

    rptWeek:
      begin
        // Trouver le premier jour de la semaine (lundi = 1)
        FirstDayOfWeek := DayOfWeek(Date);
        if FirstDayOfWeek = 1 then // Dimanche
          FirstDayOfWeek := 7
        else
          FirstDayOfWeek := FirstDayOfWeek - 1;

        case cboPredefined.ItemIndex of
          0: // Cette semaine
            begin
              FStartDate := Date - (FirstDayOfWeek - 1);
              FEndDate := FStartDate + 6;
            end;
          1: // Semaine dernière
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - 7;
              FEndDate := FStartDate + 6;
            end;
          2: // 4 dernières semaines
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - (3 * 7);
              FEndDate := Date;
            end;
          3: // 13 dernières semaines
            begin
              FStartDate := Date - (FirstDayOfWeek - 1) - (12 * 7);
              FEndDate := Date;
            end;
        end;
      end;

    rptMonth:
      begin
        DecodeDate(Date, Y, M, D);

        case cboPredefined.ItemIndex of
          0: // Ce mois-ci
            begin
              FStartDate := EncodeDate(Y, M, 1);
              FEndDate := IncMonth(FStartDate, 1) - 1;
            end;
          1: // Mois dernier
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -1);
              FEndDate := EncodeDate(Y, M, 1) - 1;
            end;
          2: // 3 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -2);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
          3: // 6 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -5);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
          4: // 12 derniers mois
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -11);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 1) - 1;
            end;
        end;
      end;

    rptQuarter:
      begin
        DecodeDate(Date, Y, M, D);
        // Calculer le premier mois du trimestre (1, 4, 7 ou 10)
        M := ((M - 1) div 3) * 3 + 1;

        case cboPredefined.ItemIndex of
          0: // Ce trimestre
            begin
              FStartDate := EncodeDate(Y, M, 1);
              FEndDate := IncMonth(FStartDate, 3) - 1;
            end;
          1: // Trimestre dernier
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -3);
              FEndDate := EncodeDate(Y, M, 1) - 1;
            end;
          2: // 4 derniers trimestres
            begin
              FStartDate := IncMonth(EncodeDate(Y, M, 1), -9);
              FEndDate := IncMonth(EncodeDate(Y, M, 1), 3) - 1;
            end;
        end;
      end;

    rptYear:
      begin
        DecodeDate(Date, Y, M, D);

        case cboPredefined.ItemIndex of
          0: // Cette année
            begin
              FStartDate := EncodeDate(Y, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
          1: // Année dernière
            begin
              FStartDate := EncodeDate(Y - 1, 1, 1);
              FEndDate := EncodeDate(Y - 1, 12, 31);
            end;
          2: // 3 dernières années
            begin
              FStartDate := EncodeDate(Y - 2, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
          3: // 5 dernières années
            begin
              FStartDate := EncodeDate(Y - 4, 1, 1);
              FEndDate := EncodeDate(Y, 12, 31);
            end;
        end;
      end;

    rptCustom:
      begin
        // Pour la période personnalisée, utiliser les valeurs des DateTimePickers
        FStartDate := dtpStartDate.Date;
        FEndDate := dtpEndDate.Date;
      end;
  end;

  // Mettre à jour les DateTimePickers
  dtpStartDate.Date := FStartDate;
  dtpEndDate.Date := FEndDate;
end;

procedure TfrmReportPeriod.rbDayClick(Sender: TObject);
begin
  FPeriodType := rptDay;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbWeekClick(Sender: TObject);
begin
  FPeriodType := rptWeek;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbMonthClick(Sender: TObject);
begin
  FPeriodType := rptMonth;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbQuarterClick(Sender: TObject);
begin
  FPeriodType := rptQuarter;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbYearClick(Sender: TObject);
begin
  FPeriodType := rptYear;
  UpdateControls;
  UpdatePredefinedList;
  UpdateDates;
end;

procedure TfrmReportPeriod.rbCustomClick(Sender: TObject);
begin
  FPeriodType := rptCustom;
  UpdateControls;

  // Pour la période personnalisée, initialiser avec le mois en cours
  dtpStartDate.Date := StartOfTheMonth(Date);
  dtpEndDate.Date := EndOfTheMonth(Date);
  UpdateDates;
end;

procedure TfrmReportPeriod.cboPredefinedChange(Sender: TObject);
begin
  UpdateDates;
end;

procedure TfrmReportPeriod.btnGenerateClick(Sender: TObject);
begin
  // Si période personnalisée, vérifier que les dates sont valides
  if FPeriodType = rptCustom then
  begin
    FStartDate := dtpStartDate.Date;
    FEndDate := dtpEndDate.Date;

    if FStartDate > FEndDate then
    begin
      ShowMessage('La date de début doit être antérieure à la date de fin.');
      Exit;
    end;
  end;

  ModalResult := mrOk;
end;

procedure TfrmReportPeriod.btnCancelClick(Sender: TObject);
begin
  ModalResult := mrCancel;
end;

function TfrmReportPeriod.GetPeriodTypeString: string;
begin
  case FPeriodType of
    rptDay: Result := 'DAY';
    rptWeek: Result := 'WEEK';
    rptMonth: Result := 'MONTH';
    rptQuarter: Result := 'QUARTER';
    rptYear: Result := 'YEAR';
    rptCustom: Result := 'CUSTOM';
  end;
end;

end.
```

## Intégration de graphiques avancés avec TeeChart Pro

Pour des visualisations plus sophistiquées, nous pouvons utiliser les fonctionnalités avancées de TeeChart Pro :

```pascal
procedure TfrmDashboard.CreateAdvancedCharts;
var
  Series1: TPieSeries;
  Series2: TBarSeries;
  Series3: TFastLineSeries;
begin
  // Graphique d'analyse des ventes par catégorie (camembert)
  Series1 := TPieSeries.Create(chartCategories);
  with Series1 do
  begin
    ParentChart := chartCategories;
    Title := 'Ventes par catégorie';
    Marks.Style := smsLabelPercent;
    Marks.Arrow.Visible := True;
    Circled := True;
    ExplodeBiggest := 20;

    // Ajouter les valeurs (à remplacer par des données réelles)
    Add(1250, 'Informatique', clRed);
    Add(850, 'Bureautique', clBlue);
    Add(620, 'Mobilier', clGreen);
    Add(410, 'Consommables', clYellow);
    Add(320, 'Accessoires', clPurple);
  end;

  // Configuration du graphique
  with chartCategories do
  begin
    Title.Text.Clear;
    Title.Text.Add('Répartition des ventes par catégorie');
    Title.Font.Size := 12;
    Legend.Visible := True;
    View3D := True;
    View3DOptions.Elevation := 315;
    View3DOptions.Perspective := 0;
    View3DOptions.Rotation := 360;
  end;

  // Graphique de tendance des ventes (courbes)
  Series3 := TFastLineSeries.Create(chartTrend);
  with Series3 do
  begin
    ParentChart := chartTrend;
    Title := 'Ventes';
    LinePen.Width := 3;
    LinePen.Color := clBlue;
    Pointer.Visible := True;
    Pointer.Style := psCircle;
    Pointer.Size := 4;

    // Ajouter les valeurs (à remplacer par des données réelles)
    for var i := 1 to 12 do
      AddXY(i, Random(1000) + 500, FormatFloat('00', i) + '/2023');
  end;

  // Configuration du graphique
  with chartTrend do
  begin
    Title.Text.Clear;
    Title.Text.Add('Tendance des ventes sur 12 mois');
    Title.Font.Size := 12;
    BottomAxis.Title.Caption := 'Période';
    LeftAxis.Title.Caption := 'Montant (€)';
    Legend.Visible := False;
    View3D := False;
    BottomAxis.Grid.Visible := False;
    LeftAxis.Grid.Visible := True;
    LeftAxis.Grid.Style := psDot;
  end;

  // Graphique comparatif mensuel (histogramme)
  Series2 := TBarSeries.Create(chartMonthly);
  with Series2 do
  begin
    ParentChart := chartMonthly;
    Title := 'Cette année';
    Marks.Visible := True;
    Marks.Style := smsValue;
    BarStyle := bsRectangle;
    Color := clBlue;

    // Ajouter les valeurs (à remplacer par des données réelles)
    for var i := 1 to 12 do
      Add(Random(1000) + 500, ShortMonthNames[i]);
  end;

  // Ajouter une seconde série pour la comparaison
  Series2 := TBarSeries.Create(chartMonthly);
  with Series2 do
  begin
    ParentChart := chartMonthly;
    Title := 'Année précédente';
    Marks.Visible := False;
    BarStyle := bsRectangle;
    Color := clRed;

    // Ajouter les valeurs (à remplacer par des données réelles)
    for var i := 1 to 12 do
      Add(Random(1000) + 300, ShortMonthNames[i]);
  end;

  // Configuration du graphique
  with chartMonthly do
  begin
    Title.Text.Clear;
    Title.Text.Add('Comparaison mensuelle des ventes');
    Title.Font.Size := 12;
    BottomAxis.Title.Caption := 'Mois';
    LeftAxis.Title.Caption := 'Montant (€)';
    Legend.Visible := True;
    View3D := False;
    BottomAxis.Grid.Visible := False;
    LeftAxis.Grid.Visible := True;
    LeftAxis.Grid.Style := psDot;
    SeriesList.MultiBar := mbSide;
  end;
end;
```

## Création d'un tableau de bord interactif avec des indicateurs clés de performance (KPI)

Un tableau de bord efficace doit mettre en avant les indicateurs clés de performance (KPI). Créons un formulaire spécifique pour cela :

```pascal
unit FormKpiDashboard;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.Imaging.pngimage, Vcl.ComCtrls, Data.DB, FireDAC.Comp.Client, dmDatabase,
  VclTee.TeeGDIPlus, VclTee.TeEngine, VclTee.TeeProcs, VclTee.Chart, VclTee.Series;

type
  TKpiPanel = class(TPanel)
  private
    FTitleLabel: TLabel;
    FValueLabel: TLabel;
    FChangeLabel: TLabel;
    FIcon: TImage;
  public
    constructor Create(AOwner: TComponent); override;

    procedure SetKpi(const ATitle: string; AValue: Double; AChange: Double;
      const AFormatStr: string = '#,##0');
  end;

  TfrmKpiDashboard = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    cboDateRange: TComboBox;
    lblDateRange: TLabel;
    pnlMain: TPanel;
    pnlKpi: TPanel;
    pnlCharts: TPanel;
    chartSales: TChart;
    chartCustomers: TChart;
    seriesSales: TLineSeries;
    seriesCustomers: TLineSeries;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure cboDateRangeChange(Sender: TObject);
  private
    { Déclarations privées }
    FKpiPanels: array[0..3] of TKpiPanel;
    FSalesQuery: TFDQuery;
    FCustomersQuery: TFDQuery;

    procedure CreateKpiPanels;
    procedure LoadKpiData;
    procedure LoadChartData;
    function GetDateRange: TDateRange;
  public
    { Déclarations publiques }
  end;

var
  frmKpiDashboard: TfrmKpiDashboard;

implementation

{$R *.dfm}

// Implémentation de TKpiPanel

constructor TKpiPanel.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);

  // Configurer le panel
  BevelOuter := bvNone;
  ParentBackground := False;

  // Créer le label de titre
  FTitleLabel := TLabel.Create(Self);
  FTitleLabel.Parent := Self;
  FTitleLabel.Align := alTop;
  FTitleLabel.Alignment := taCenter;
  FTitleLabel.Font.Style := [fsBold];
  FTitleLabel.Height := 20;

  // Créer le label de valeur
  FValueLabel := TLabel.Create(Self);
  FValueLabel.Parent := Self;
  FValueLabel.Align := alClient;
  FValueLabel.Alignment := taCenter;
  FValueLabel.Layout := tlCenter;
  FValueLabel.Font.Size := 20;
  FValueLabel.Font.Style := [fsBold];

  // Créer le label de variation
  FChangeLabel := TLabel.Create(Self);
  FChangeLabel.Parent := Self;
  FChangeLabel.Align := alBottom;
  FChangeLabel.Alignment := taCenter;
  FChangeLabel.Height := 20;

  // Créer l'icône
  FIcon := TImage.Create(Self);
  FIcon.Parent := Self;
  FIcon.Align := alRight;
  FIcon.Width := 32;
  FIcon.Transparent := True;
  FIcon.Visible := False;
end;

procedure TKpiPanel.SetKpi(const ATitle: string; AValue: Double; AChange: Double;
  const AFormatStr: string = '#,##0');
begin
  // Définir le titre
  FTitleLabel.Caption := ATitle;

  // Définir la valeur
  FValueLabel.Caption := FormatFloat(AFormatStr, AValue);

  // Définir la variation
  if AChange > 0 then
  begin
    FChangeLabel.Caption := '▲ ' + FormatFloat('+0.0%', AChange);
    FChangeLabel.Font.Color := clGreen;
  end
  else if AChange < 0 then
  begin
    FChangeLabel.Caption := '▼ ' + FormatFloat('0.0%', AChange);
    FChangeLabel.Font.Color := clRed;
  end
  else
  begin
    FChangeLabel.Caption := '◎ 0.0%';
    FChangeLabel.Font.Color := clGray;
  end;
end;

// Implémentation de TfrmKpiDashboard

procedure TfrmKpiDashboard.FormCreate(Sender: TObject);
begin
  // Créer les requêtes
  FSalesQuery := TFDQuery.Create(Self);
  FSalesQuery.Connection := DataModuleDB.FDConnection;

  FCustomersQuery := TFDQuery.Create(Self);
  FCustomersQuery.Connection := DataModuleDB.FDConnection;

  // Créer les panneaux KPI
  CreateKpiPanels;

  // Remplir la combobox des périodes
  cboDateRange.Items.Clear;
  cboDateRange.Items.Add('7 derniers jours');
  cboDateRange.Items.Add('30 derniers jours');
  cboDateRange.Items.Add('Ce mois-ci');
  cboDateRange.Items.Add('Ce trimestre');
  cboDateRange.Items.Add('Cette année');
  cboDateRange.ItemIndex := 2; // Ce mois-ci par défaut

  // Charger les données
  LoadKpiData;
  LoadChartData;
end;

procedure TfrmKpiDashboard.FormDestroy(Sender: TObject);
begin
  FSalesQuery.Free;
  FCustomersQuery.Free;
end;

procedure TfrmKpiDashboard.CreateKpiPanels;
var
  i: Integer;
begin
  // Créer 4 panneaux KPI
  for i := 0 to 3 do
  begin
    FKpiPanels[i] := TKpiPanel.Create(Self);
    FKpiPanels[i].Parent := pnlKpi;
    FKpiPanels[i].Align := alLeft;
    FKpiPanels[i].Width := (pnlKpi.Width div 4) - 10;
    FKpiPanels[i].Margins.Left := 5;
    FKpiPanels[i].Margins.Right := 5;
    FKpiPanels[i].Margins.Top := 5;
    FKpiPanels[i].Margins.Bottom := 5;
    FKpiPanels[i].AlignWithMargins := True;

    // Couleurs des panneaux
    case i of
      0: FKpiPanels[i].Color := $00D1E7F6; // Bleu clair
      1: FKpiPanels[i].Color := $00D1F6D7; // Vert clair
      2: FKpiPanels[i].Color := $00F6EAD1; // Orange clair
      3: FKpiPanels[i].Color := $00F6D1D1; // Rouge clair
    end;
  end;
end;

procedure TfrmKpiDashboard.LoadKpiData;
var
  DateRange: TDateRange;
  StartDate, EndDate, PrevStartDate, PrevEndDate: TDateTime;
  CurrentCA, PreviousCA: Double;
  CurrentOrders, PreviousOrders: Integer;
  CurrentNewCustomers, PreviousNewCustomers: Integer;
  CurrentAvgOrder, PreviousAvgOrder: Double;
  Variation: Double;
begin
  // Déterminer la période
  DateRange := GetDateRange;

  // Période actuelle
  StartDate := DateRange.StartDate;
  EndDate := DateRange.EndDate;

  // Période précédente (même durée que la période actuelle)
  PrevStartDate := StartDate - (EndDate - StartDate + 1);
  PrevEndDate := StartDate - 1;

  // 1. Chiffre d'affaires
  FSalesQuery.Close;
  FSalesQuery.SQL.Text :=
    'SELECT SUM(MontantTTC) AS TotalCA FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annulée'')';

  // Période actuelle
  FSalesQuery.ParamByName('StartDate').AsDate := StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := EndDate;
  FSalesQuery.Open;
  CurrentCA := FSalesQuery.FieldByName('TotalCA').AsFloat;

  // Période précédente
  FSalesQuery.Close;
  FSalesQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FSalesQuery.Open;
  PreviousCA := FSalesQuery.FieldByName('TotalCA').AsFloat;

  // Calculer la variation en pourcentage
  if PreviousCA > 0 then
    Variation := ((CurrentCA - PreviousCA) / PreviousCA) * 100
  else
    Variation := 0;

  // Mettre à jour le KPI
  FKpiPanels[0].SetKpi('Chiffre d''affaires', CurrentCA, Variation, '#,##0.00 €');

  // 2. Nombre de commandes
  FSalesQuery.Close;
  FSalesQuery.SQL.Text :=
    'SELECT COUNT(*) AS TotalOrders FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annulée'')';

  // Période actuelle
  FSalesQuery.ParamByName('StartDate').AsDate := StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := EndDate;
  FSalesQuery.Open;
  CurrentOrders := FSalesQuery.FieldByName('TotalOrders').AsInteger;

  // Période précédente
  FSalesQuery.Close;
  FSalesQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FSalesQuery.Open;
  PreviousOrders := FSalesQuery.FieldByName('TotalOrders').AsInteger;

  // Calculer la variation
  if PreviousOrders > 0 then
    Variation := ((CurrentOrders - PreviousOrders) / PreviousOrders) * 100
  else
    Variation := 0;

  // Mettre à jour le KPI
  FKpiPanels[1].SetKpi('Nombre de commandes', CurrentOrders, Variation);

  // 3. Nouveaux clients
  FCustomersQuery.Close;
  FCustomersQuery.SQL.Text :=
    'SELECT COUNT(*) AS NewCustomers FROM Clients ' +
    'WHERE DateCreation BETWEEN :StartDate AND :EndDate';

  // Période actuelle
  FCustomersQuery.ParamByName('StartDate').AsDate := StartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := EndDate;
  FCustomersQuery.Open;
  CurrentNewCustomers := FCustomersQuery.FieldByName('NewCustomers').AsInteger;

  // Période précédente
  FCustomersQuery.Close;
  FCustomersQuery.ParamByName('StartDate').AsDate := PrevStartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := PrevEndDate;
  FCustomersQuery.Open;
  PreviousNewCustomers := FCustomersQuery.FieldByName('NewCustomers').AsInteger;

  // Calculer la variation
  if PreviousNewCustomers > 0 then
    Variation := ((CurrentNewCustomers - PreviousNewCustomers) / PreviousNewCustomers) * 100
  else
    Variation := 0;

  // Mettre à jour le KPI
  FKpiPanels[2].SetKpi('Nouveaux clients', CurrentNewCustomers, Variation);

  // 4. Panier moyen
  if CurrentOrders > 0 then
    CurrentAvgOrder := CurrentCA / CurrentOrders
  else
    CurrentAvgOrder := 0;

  if PreviousOrders > 0 then
    PreviousAvgOrder := PreviousCA / PreviousOrders
  else
    PreviousAvgOrder := 0;

  // Calculer la variation
  if PreviousAvgOrder > 0 then
    Variation := ((CurrentAvgOrder - PreviousAvgOrder) / PreviousAvgOrder) * 100
  else
    Variation := 0;

  // Mettre à jour le KPI
  FKpiPanels[3].SetKpi('Panier moyen', CurrentAvgOrder, Variation, '#,##0.00 €');
end;

procedure TfrmKpiDashboard.LoadChartData;
var
  DateRange: TDateRange;
  SQL: string;
  DateFormat, GroupBy: string;
begin
  // Déterminer le format de date et le regroupement en fonction de la période
  case cboDateRange.ItemIndex of
    0, 1: // 7 ou 30 derniers jours
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
    2: // Ce mois-ci
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
    3: // Ce trimestre
      begin
        DateFormat := '%v';
        GroupBy := 'YEARWEEK(DateCommande)';
      end;
    4: // Cette année
      begin
        DateFormat := '%m/%Y';
        GroupBy := 'YEAR(DateCommande), MONTH(DateCommande)';
      end;
    else
      begin
        DateFormat := '%d/%m';
        GroupBy := 'DATE(DateCommande)';
      end;
  end;

  // Obtenir la période
  DateRange := GetDateRange;

  // Charger les données des ventes
  seriesSales.Clear;

  FSalesQuery.Close;
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroup, ' +
    'DATE_FORMAT(DateCommande, ''' + DateFormat + ''') AS DateDisplay, ' +
    'SUM(MontantTTC) AS TotalSales ' +
    'FROM Commandes ' +
    'WHERE DateCommande BETWEEN :StartDate AND :EndDate ' +
    'AND Statut NOT IN (''Annulée'') ' +
    'GROUP BY DateGroup ' +
    'ORDER BY DateGroup';
  FSalesQuery.SQL.Text := SQL;
  FSalesQuery.ParamByName('StartDate').AsDate := DateRange.StartDate;
  FSalesQuery.ParamByName('EndDate').AsDate := DateRange.EndDate;
  FSalesQuery.Open;

  while not FSalesQuery.Eof do
  begin
    seriesSales.AddXY(
      seriesSales.Count + 1,
      FSalesQuery.FieldByName('TotalSales').AsFloat,
      FSalesQuery.FieldByName('DateDisplay').AsString
    );
    FSalesQuery.Next;
  end;

  // Configurer le graphique des ventes
  chartSales.Title.Text.Clear;
  chartSales.Title.Text.Add('Évolution des ventes');
  chartSales.LeftAxis.Title.Caption := 'Montant (€)';
  chartSales.BottomAxis.Title.Caption := 'Période';

  // Charger les données des nouveaux clients
  seriesCustomers.Clear;

  FCustomersQuery.Close;
  SQL :=
    'SELECT ' + GroupBy + ' AS DateGroup, ' +
    'DATE_FORMAT(DateCreation, ''' + DateFormat + ''') AS DateDisplay, ' +
    'COUNT(*) AS NewCustomers ' +
    'FROM Clients ' +
    'WHERE DateCreation BETWEEN :StartDate AND :EndDate ' +
    'GROUP BY DateGroup ' +
    'ORDER BY DateGroup';
  FCustomersQuery.SQL.Text := SQL;
  FCustomersQuery.ParamByName('StartDate').AsDate := DateRange.StartDate;
  FCustomersQuery.ParamByName('EndDate').AsDate := DateRange.EndDate;
  FCustomersQuery.Open;

  while not FCustomersQuery.Eof do
  begin
    seriesCustomers.AddXY(
      seriesCustomers.Count + 1,
      FCustomersQuery.FieldByName('NewCustomers').AsFloat,
      FCustomersQuery.FieldByName('DateDisplay').AsString
    );
    FCustomersQuery.Next;
  end;

  // Configurer le graphique des clients
  chartCustomers.Title.Text.Clear;
  chartCustomers.Title.Text.Add('Nouveaux clients');
  chartCustomers.LeftAxis.Title.Caption := 'Nombre';
  chartCustomers.BottomAxis.Title.Caption := 'Période';
end;

function TfrmKpiDashboard.GetDateRange: TDateRange;
var
  Y, M, D: Word;
begin
  case cboDateRange.ItemIndex of
    0: // 7 derniers jours
      begin
        Result.StartDate := Date - 6;
        Result.EndDate := Date;
      end;
    1: // 30 derniers jours
      begin
        Result.StartDate := Date - 29;
        Result.EndDate := Date;
      end;
    2: // Ce mois-ci
      begin
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 1) - 1;
      end;
    3: // Ce trimestre
      begin
        DecodeDate(Date, Y, M, D);
        // Calculer le premier mois du trimestre (1, 4, 7 ou 10)
        M := ((M - 1) div 3) * 3 + 1;
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 3) - 1;
      end;
    4: // Cette année
      begin
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, 1, 1);
        Result.EndDate := EncodeDate(Y, 12, 31);
      end;
    else
      begin
        // Par défaut, ce mois-ci
        DecodeDate(Date, Y, M, D);
        Result.StartDate := EncodeDate(Y, M, 1);
        Result.EndDate := IncMonth(Result.StartDate, 1) - 1;
      end;
  end;
end;

procedure TfrmKpiDashboard.cboDateRangeChange(Sender: TObject);
begin
  LoadKpiData;
  LoadChartData;
end;
```

## Création d'un rapport de performance commerciale

Un rapport de performance commerciale est essentiel pour suivre les résultats de l'équipe de vente. Créons ce rapport :

```pascal
procedure TDataModuleReports.PrepareSalesPerformanceReport;
begin
  // Configurer la requête
  qrySalesPerformance.Close;
  qrySalesPerformance.SQL.Text :=
    'SELECT u.UtilisateurID, CONCAT(u.Nom, '' '', u.Prenom) AS Vendeur, ' +
    'COUNT(c.CommandeID) AS NombreCommandes, ' +
    'SUM(c.MontantHT) AS TotalHT, ' +
    'SUM(c.MontantTTC) AS TotalTTC, ' +
    'MAX(c.MontantTTC) AS CommandeMax, ' +
    'AVG(c.MontantTTC) AS CommandeMoyenne, ' +
    '(SELECT COUNT(DISTINCT c2.ClientID) ' +
    ' FROM Commandes c2 ' +
    ' WHERE c2.UtilisateurID = u.UtilisateurID ' +
    ' AND c2.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    ' AND c2.Statut NOT IN (''Annulée'')) AS NombreClients ' +
    'FROM Utilisateurs u ' +
    'LEFT JOIN Commandes c ON u.UtilisateurID = c.UtilisateurID ' +
    'AND c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annulée'') ' +
    'WHERE u.RoleID = 2 ' + // Supposons que RoleID 2 = Vendeurs
    'GROUP BY u.UtilisateurID ' +
    'ORDER BY TotalTTC DESC';

  qrySalesPerformance.ParamByName('DateDebut').AsDate := Date - 30; // Par défaut, 30 derniers jours
  qrySalesPerformance.ParamByName('DateFin').AsDate := Date;
  qrySalesPerformance.Open;
end;

procedure TDataModuleReports.PrepareSalesPerformanceDetailReport(AUtilisateurID: Integer);
begin
  // Configurer la requête pour le détail des commandes d'un vendeur
  qrySalesPerformanceDetail.Close;
  qrySalesPerformanceDetail.SQL.Text :=
    'SELECT c.CommandeID, c.Reference, c.DateCommande, ' +
    'CONCAT(cl.Nom, '' '', cl.Prenom) AS Client, ' +
    'c.MontantHT, c.MontantTTC, c.Statut, ' +
    '(SELECT COUNT(*) FROM LignesCommande l WHERE l.CommandeID = c.CommandeID) AS NbProduits ' +
    'FROM Commandes c ' +
    'JOIN Clients cl ON c.ClientID = cl.ClientID ' +
    'WHERE c.UtilisateurID = :UtilisateurID ' +
    'AND c.DateCommande BETWEEN :DateDebut AND :DateFin ' +
    'AND c.Statut NOT IN (''Annulée'') ' +
    'ORDER BY c.DateCommande DESC';

  qrySalesPerformanceDetail.ParamByName('UtilisateurID').AsInteger := AUtilisateurID;
  qrySalesPerformanceDetail.ParamByName('DateDebut').AsDate := Date - 30;
  qrySalesPerformanceDetail.ParamByName('DateFin').AsDate := Date;
  qrySalesPerformanceDetail.Open;
end;
```

## Exportation des rapports et tableaux de bord

Pour terminer, implémentons une fonctionnalité pour exporter nos rapports et tableaux de bord dans différents formats :

```pascal
procedure TfrmDashboard.ExportToPdf;
var
  SaveDialog: TSaveDialog;
  FileName: string;
  MetaFile: TMetafile;
  Canvas: TMetafileCanvas;
  R: TRect;
begin
  SaveDialog := TSaveDialog.Create(nil);
  try
    SaveDialog.Title := 'Exporter le tableau de bord en PDF';
    SaveDialog.Filter := 'Fichiers PDF (*.pdf)|*.pdf';
    SaveDialog.DefaultExt := 'pdf';
    SaveDialog.FileName := 'tableau_bord_' + FormatDateTime('yyyymmdd', Date) + '.pdf';

    if SaveDialog.Execute then
    begin
      FileName := SaveDialog.FileName;

      // Créer un PDF avec ReportBuilder, FastReport ou une autre bibliothèque
      // Voici un exemple qui crée un métafichier de la forme actuelle

      // Créer un métafichier
      R := Rect(0, 0, Self.Width, Self.Height);
      MetaFile := TMetafile.Create;
      try
        MetaFile.Width := Self.Width;
        MetaFile.Height := Self.Height;

        Canvas := TMetafileCanvas.Create(MetaFile, 0);
        try
          Self.PaintTo(Canvas, 0, 0);
        finally
          Canvas.Free;
        end;

        // Sauvegarder le métafichier dans un PDF
        // (Cette partie nécessite une bibliothèque PDF comme SynPDF ou TPDF)
        // Ici, nous montrons simplement un message de succès
        ShowMessage('Export PDF créé avec succès : ' + FileName);
      finally
        MetaFile.Free;
      end;
    end;
  finally
    SaveDialog.Free;
  end;
end;

procedure TfrmDashboard.ExportToExcel;
var
  SaveDialog: TSaveDialog;
  FileName: string;
  Excel: Variant;
  Sheet: Variant;
  i, Col, Row: Integer;
begin
  SaveDialog := TSaveDialog.Create(nil);
  try
    SaveDialog.Title := 'Exporter les données en Excel';
    SaveDialog.Filter := 'Fichiers Excel (*.xlsx)|*.xlsx';
    SaveDialog.DefaultExt := 'xlsx';
    SaveDialog.FileName := 'donnees_' + FormatDateTime('yyyymmdd', Date) + '.xlsx';

    if SaveDialog.Execute then
    begin
      FileName := SaveDialog.FileName;

      // Utiliser la bibliothèque OLE Automation pour Excel
      try
        Excel := CreateOleObject('Excel.Application');
        Excel.Visible := False;
        Excel.Workbooks.Add;
        Sheet := Excel.Workbooks[1].Worksheets[1];

        // Titre du rapport
        Sheet.Cells[1, 1] := 'Tableau de bord - Données';
        Sheet.Cells[1, 1].Font.Bold := True;
        Sheet.Cells[1, 1].Font.Size := 14;

        // En-têtes (exemple)
        Sheet.Cells[3, 1] := 'Période';
        Sheet.Cells[3, 2] := 'Ventes';
        Sheet.Cells[3, 3] := 'Nouveaux clients';

        // Boucle pour ajouter les données (exemple simplifié)
        for i := 0 to seriesSales.Count - 1 do
        begin
          Row := i + 4;
          Sheet.Cells[Row, 1] := seriesSales.XLabel[i];
          Sheet.Cells[Row, 2] := seriesSales.YValue[i];

          if i < seriesCustomers.Count then
            Sheet.Cells[Row, 3] := seriesCustomers.YValue[i];
        end;

        // Formatage
        Sheet.Range['A3:C3'].Font.Bold := True;
        Sheet.Range['A1:C' + IntToStr(seriesSales.Count + 4)].Columns.AutoFit;

        // Sauvegarder et fermer
        Excel.Workbooks[1].SaveAs(FileName);
        Excel.Quit;

        ShowMessage('Export Excel créé avec succès : ' + FileName);
      except
        on E: Exception do
          ShowMessage('Erreur lors de l''export Excel : ' + E.Message);
      end;
    end;
  finally
    SaveDialog.Free;
    Excel := Unassigned;
  end;
end;
```

## Intégration d'un sélecteur de rapports

Pour faciliter l'accès à tous les rapports, créons un formulaire centralisé :

```pascal
unit FormReportSelector;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Imaging.pngimage, dmReports, FormReportPeriod;

type
  TfrmReportSelector = class(TForm)
    pnlTop: TPanel;
    lblTitle: TLabel;
    pnlClient: TPanel;
    flpnlReports: TFlowPanel;
    pnlBottom: TPanel;
    btnClose: TButton;
    procedure FormCreate(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { Déclarations privées }
    procedure CreateReportButtons;
    procedure ReportButtonClick(Sender: TObject);
  public
    { Déclarations publiques }
  end;

var
  frmReportSelector: TfrmReportSelector;

implementation

{$R *.dfm}

uses
  FormSalesReport, FormInventoryReport, FormSalesPerformanceReport,
  FormCustomerAnalysisReport, FormDashboard, FormKpiDashboard;

procedure TfrmReportSelector.FormCreate(Sender: TObject);
begin
  CreateReportButtons;
end;

procedure TfrmReportSelector.CreateReportButtons;
type
  TReportInfo = record
    Title: string;
    Description: string;
    FormClass: TFormClass;
    ImageName: string;
  end;
var
  Reports: array[0..5] of TReportInfo;
  Panel: TPanel;
  Image: TImage;
  LblTitle, LblDesc: TLabel;
  i: Integer;
begin
  // Définir les rapports disponibles
  Reports[0].Title := 'Rapport des ventes';
  Reports[0].Description := 'Analyse des ventes par période';
  Reports[0].FormClass := TfrmSalesReport;
  Reports[0].ImageName := 'report_sales.png';

  Reports[1].Title := 'État des stocks';
  Reports[1].Description := 'Inventaire et niveaux de stock';
  Reports[1].FormClass := TfrmInventoryReport;
  Reports[1].ImageName := 'report_inventory.png';

  Reports[2].Title := 'Performance commerciale';
  Reports[2].Description := 'Analyse des performances des vendeurs';
  Reports[2].FormClass := TfrmSalesPerformanceReport;
  Reports[2].ImageName := 'report_performance.png';

  Reports[3].Title := 'Analyse clients';
  Reports[3].Description := 'Statistiques et comportements clients';
  Reports[3].FormClass := TfrmCustomerAnalysisReport;
  Reports[3].ImageName := 'report_customers.png';

  Reports[4].Title := 'Tableau de bord';
  Reports[4].Description := 'Vue d''ensemble de l''activité';
  Reports[4].FormClass := TfrmDashboard;
  Reports[4].ImageName := 'dashboard.png';

  Reports[5].Title := 'KPI';
  Reports[5].Description := 'Indicateurs clés de performance';
  Reports[5].FormClass := TfrmKpiDashboard;
  Reports[5].ImageName := 'kpi.png';

  // Créer les boutons de rapport
  for i := 0 to High(Reports) do
  begin
    Panel := TPanel.Create(Self);
    Panel.Parent := flpnlReports;
    Panel.Width := 200;
    Panel.Height := 150;
    Panel.Padding.SetBounds(5, 5, 5, 5);
    Panel.BevelOuter := bvNone;
    Panel.ParentBackground := False;
    Panel.ParentColor := False;
    Panel.Color := clWhite;
    Panel.Tag := i; // Stocker l'index pour l'événement OnClick
    Panel.OnClick := ReportButtonClick;
    Panel.Cursor := crHandPoint;

    // Ajouter l'image
    Image := TImage.Create(Panel);
    Image.Parent := Panel;
    Image.Align := alTop;
    Image.Height := 64;
    Image.Center := True;
    Image.Proportional := True;
    Image.Transparent := True;

    // Charger l'image si elle existe
    try
      if FileExists(ExtractFilePath(Application.ExeName) + 'Resources\Images\' + Reports[i].ImageName) then
        Image.Picture.LoadFromFile(ExtractFilePath(Application.ExeName) + 'Resources\Images\' + Reports[i].ImageName);
    except
      // Ignorer les erreurs de chargement d'image
    end;

    // Ajouter le titre
    LblTitle := TLabel.Create(Panel);
    LblTitle.Parent := Panel;
    LblTitle.Align := alTop;
    LblTitle.Alignment := taCenter;
    LblTitle.Font.Style := [fsBold];
    LblTitle.Font.Size := 10;
    LblTitle.Caption := Reports[i].Title;
    LblTitle.Top := Image.Height + 10;
    LblTitle.Height := 20;

    // Ajouter la description
    LblDesc := TLabel.Create(Panel);
    LblDesc.Parent := Panel;
    LblDesc.Align := alClient;
    LblDesc.Alignment := taCenter;
    LblDesc.WordWrap := True;
    LblDesc.Caption := Reports[i].Description;
  end;
end;

procedure TfrmReportSelector.ReportButtonClick(Sender: TObject);
var
  Panel: TPanel;
  ReportIndex: Integer;
  Form: TForm;
begin
  if Sender is TPanel then
  begin
    Panel := TPanel(Sender);
    ReportIndex := Panel.Tag;

    // Créer et afficher le formulaire correspondant
    case ReportIndex of
      0: // Rapport des ventes
        begin
          Form := TfrmSalesReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      1: // État des stocks
        begin
          Form := TfrmInventoryReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      2: // Performance commerciale
        begin
          Form := TfrmSalesPerformanceReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      3: // Analyse clients
        begin
          Form := TfrmCustomerAnalysisReport.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      4: // Tableau de bord
        begin
          Form := TfrmDashboard.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
      5: // KPI
        begin
          Form := TfrmKpiDashboard.Create(nil);
          try
            Form.ShowModal;
          finally
            Form.Free;
          end;
        end;
    end;
  end;
end;

procedure TfrmReportSelector.btnCloseClick(Sender: TObject);
begin
  Close;
end;

end.
```

## Conclusion

Dans cette section, nous avons développé un système complet de rapports et tableaux de bord pour notre application de gestion avec MySQL/MariaDB. Ces fonctionnalités permettent aux utilisateurs d'analyser leurs données commerciales et de prendre des décisions éclairées.

### Points clés abordés :

1. **Rapports statiques avec FastReport**
   - Rapports de ventes
   - États d'inventaire
   - Analyses commerciales
   - Exportation dans différents formats (PDF, Excel, etc.)

2. **Tableaux de bord dynamiques avec TeeChart**
   - Graphiques de tendances
   - Analyses comparatives
   - Indicateurs clés de performance (KPI)
   - Filtrage des données par période

3. **Interfaces utilisateur conviviales**
   - Sélection de périodes sophistiquée
   - Navigation intuitive entre les rapports
   - Présentation visuelle des données
   - Options d'exportation et de partage

### Avantages pour les utilisateurs :

- **Analyse approfondie** : Compréhension détaillée des performances de l'entreprise
- **Prise de décision éclairée** : Informations pertinentes pour orienter les stratégies commerciales
- **Suivi des objectifs** : Possibilité de mesurer les résultats par rapport aux objectifs fixés
- **Identification des tendances** : Détection des évolutions positives ou négatives
- **Communication efficace** : Partage des résultats avec les parties prenantes

### Axes d'amélioration possibles :

Pour enrichir davantage votre système de rapports, vous pourriez envisager :

1. **Intégration de l'intelligence artificielle** : Analyse prédictive des ventes futures
2. **Notifications automatiques** : Alertes lorsque certains indicateurs atteignent des seuils critiques
3. **Rapports personnalisés** : Permettre aux utilisateurs de créer leurs propres rapports
4. **Tableaux de bord mobiles** : Adaptation pour consultation sur smartphones et tablettes
5. **Analyses géographiques** : Cartographie des ventes par région

## Bonnes pratiques pour les rapports et tableaux de bord

Pour garantir l'efficacité de vos rapports et tableaux de bord, voici quelques recommandations :

### 1. Conception claire et accessible

```pascal
// Exemple de code pour améliorer la lisibilité d'un graphique
procedure TfrmDashboard.OptimizeChartReadability(AChart: TChart);
begin
  // Utiliser des couleurs contrastées
  AChart.SeriesList[0].Color := clNavy;
  AChart.SeriesList[1].Color := clRed;

  // Augmenter la taille des polices
  AChart.Title.Font.Size := 12;
  AChart.Title.Font.Style := [fsBold];
  AChart.Legend.Font.Size := 10;

  // Ajouter une grille pour faciliter la lecture
  AChart.LeftAxis.Grid.Visible := True;
  AChart.LeftAxis.Grid.Style := psDot;

  // Limiter le nombre d'étiquettes sur l'axe X pour éviter l'encombrement
  if AChart.BottomAxis.Labels.Count > 10 then
    AChart.BottomAxis.LabelsAngle := 45;
end;
```

### 2. Performance optimisée

```pascal
// Exemple de code pour optimiser les requêtes de rapport
procedure TDataModuleReports.OptimizeReportQuery;
begin
  // Ajouter des index à la base de données pour accélérer les requêtes fréquentes
  with FDConnection.ExecSQL(
    'CREATE INDEX IF NOT EXISTS idx_commandes_date ON Commandes(DateCommande)') do;

  // Utiliser des vues pour les requêtes complexes fréquemment utilisées
  with FDConnection.ExecSQL(
    'CREATE OR REPLACE VIEW vw_ventes_mensuelles AS ' +
    'SELECT YEAR(DateCommande) AS Annee, MONTH(DateCommande) AS Mois, ' +
    'SUM(MontantTTC) AS TotalVentes, COUNT(*) AS NombreCommandes ' +
    'FROM Commandes ' +
    'WHERE Statut NOT IN (''Annulée'') ' +
    'GROUP BY YEAR(DateCommande), MONTH(DateCommande)') do;

  // Limiter le volume de données chargées en mémoire
  qrySalesReport.FetchOptions.RowsetSize := 100;
end;
```

### 3. Interactivité et personnalisation

```pascal
// Exemple de code pour créer un filtre de rapport interactif
procedure TfrmCustomReport.CreateInteractiveFilter;
var
  i: Integer;
begin
  // Créer un panel pour les filtres
  pnlFilters := TPanel.Create(Self);
  pnlFilters.Parent := Self;
  pnlFilters.Align := alTop;
  pnlFilters.Height := 40;
  pnlFilters.BevelOuter := bvNone;

  // Ajouter une combobox pour filtrer par catégorie
  cboFilterCategory := TComboBox.Create(pnlFilters);
  cboFilterCategory.Parent := pnlFilters;
  cboFilterCategory.Left := 10;
  cboFilterCategory.Top := 10;
  cboFilterCategory.Width := 150;
  cboFilterCategory.Style := csDropDownList;
  cboFilterCategory.Items.Add('Toutes les catégories');

  // Charger les catégories depuis la base de données
  dmBusiness.CategorieRepository.LoadCategoriesToCombo(cboFilterCategory);
  cboFilterCategory.ItemIndex := 0;
  cboFilterCategory.OnChange := FilterChanged;

  // Ajouter un contrôle de période
  dtpStart := TDateTimePicker.Create(pnlFilters);
  dtpStart.Parent := pnlFilters;
  dtpStart.Left := 180;
  dtpStart.Top := 10;
  dtpStart.Width := 100;
  dtpStart.Date := StartOfTheMonth(Date);
  dtpStart.OnChange := FilterChanged;

  lblTo := TLabel.Create(pnlFilters);
  lblTo.Parent := pnlFilters;
  lblTo.Left := 290;
  lblTo.Top := 14;
  lblTo.Caption := 'au';

  dtpEnd := TDateTimePicker.Create(pnlFilters);
  dtpEnd.Parent := pnlFilters;
  dtpEnd.Left := 310;
  dtpEnd.Top := 10;
  dtpEnd.Width := 100;
  dtpEnd.Date := EndOfTheMonth(Date);
  dtpEnd.OnChange := FilterChanged;

  // Ajouter un bouton d'application du filtre
  btnApplyFilter := TButton.Create(pnlFilters);
  btnApplyFilter.Parent := pnlFilters;
  btnApplyFilter.Left := 420;
  btnApplyFilter.Top := 8;
  btnApplyFilter.Width := 100;
  btnApplyFilter.Caption := 'Appliquer';
  btnApplyFilter.OnClick := ApplyFilterClick;
end;
```

### 4. Documentation et aide contextuelle

```pascal
// Exemple de code pour ajouter de l'aide contextuelle
procedure TfrmReport.AddContextualHelp;
begin
  // Créer une icône d'aide
  btnHelp := TSpeedButton.Create(Self);
  btnHelp.Parent := pnlTop;
  btnHelp.Align := alRight;
  btnHelp.Width := 25;
  btnHelp.Caption := '?';
  btnHelp.Font.Style := [fsBold];
  btnHelp.Flat := True;
  btnHelp.OnClick := HelpButtonClick;

  // Créer des infobulles détaillées
  with cboDateRange do
  begin
    ShowHint := True;
    Hint := 'Sélectionnez la période pour filtrer les données du rapport.' + #13#10 +
           'Les données seront automatiquement mises à jour en fonction de votre choix.';
  end;

  with chartSales do
  begin
    ShowHint := True;
    Hint := 'Ce graphique présente l''évolution des ventes sur la période sélectionnée.' + #13#10 +
           'Survolez les points pour voir les valeurs exactes.';
  end;
end;

procedure TfrmReport.HelpButtonClick(Sender: TObject);
begin
  // Afficher un dialogue d'aide
  with TTaskDialog.Create(Self) do
  try
    Caption := 'Aide sur les rapports';
    Title := 'Utilisation des rapports';
    Text := 'Ce rapport vous permet de visualiser et d''analyser vos données de vente.' + #13#10#13#10 +
           '1. Utilisez les filtres en haut pour sélectionner la période souhaitée.' + #13#10 +
           '2. Les graphiques montrent l''évolution des ventes et autres indicateurs clés.' + #13#10 +
           '3. Vous pouvez exporter les données en PDF ou Excel via les boutons dédiés.' + #13#10 +
           '4. Pour une analyse plus détaillée, utilisez les tableaux de bord interactifs.';
    CommonButtons := [tcbClose];
    MainIcon := tdiInformation;
    Execute;
  finally
    Free;
  end;
end;
```

### 5. Exportation et partage des rapports

```pascal
// Exemple de code pour exporter un rapport avec paramètres avancés
procedure TfrmReport.ExportReportWithAdvancedOptions;
var
  ExportDialog: TForm;
  cboPdfQuality, cboExcelFormat: TComboBox;
  chkIncludeCharts, chkIncludeHeaders: TCheckBox;
  btnExport, btnCancel: TButton;
begin
  // Créer une boîte de dialogue d'options d'exportation
  ExportDialog := TForm.Create(nil);
  try
    ExportDialog.Caption := 'Options d''exportation';
    ExportDialog.Width := 400;
    ExportDialog.Height := 300;
    ExportDialog.Position := poScreenCenter;
    ExportDialog.BorderStyle := bsDialog;

    // Ajouter les contrôles pour les options
    with TLabel.Create(ExportDialog) do
    begin
      Parent := ExportDialog;
      Left := 20;
      Top := 20;
      Caption := 'Format d''exportation :';
    end;

    cboPdfQuality := TComboBox.Create(ExportDialog);
    cboPdfQuality.Parent := ExportDialog;
    cboPdfQuality.Left := 150;
    cboPdfQuality.Top := 20;
    cboPdfQuality.Width := 200;
    cboPdfQuality.Style := csDropDownList;
    cboPdfQuality.Items.Add('PDF - Qualité standard');
    cboPdfQuality.Items.Add('PDF - Haute qualité');
    cboPdfQuality.Items.Add('PDF - Optimisé pour impression');
    cboPdfQuality.Items.Add('Excel - Format moderne (XLSX)');
    cboPdfQuality.Items.Add('Excel - Format compatible (XLS)');
    cboPdfQuality.Items.Add('Word - Document (DOCX)');
    cboPdfQuality.ItemIndex := 0;

    chkIncludeCharts := TCheckBox.Create(ExportDialog);
    chkIncludeCharts.Parent := ExportDialog;
    chkIncludeCharts.Left := 20;
    chkIncludeCharts.Top := 60;
    chkIncludeCharts.Width := 350;
    chkIncludeCharts.Caption := 'Inclure les graphiques';
    chkIncludeCharts.Checked := True;

    chkIncludeHeaders := TCheckBox.Create(ExportDialog);
    chkIncludeHeaders.Parent := ExportDialog;
    chkIncludeHeaders.Left := 20;
    chkIncludeHeaders.Top := 90;
    chkIncludeHeaders.Width := 350;
    chkIncludeHeaders.Caption := 'Inclure les en-têtes et pieds de page';
    chkIncludeHeaders.Checked := True;

    // Ajouter les boutons
    btnExport := TButton.Create(ExportDialog);
    btnExport.Parent := ExportDialog;
    btnExport.Caption := 'Exporter';
    btnExport.Left := 200;
    btnExport.Top := 220;
    btnExport.Width := 80;
    btnExport.Default := True;
    btnExport.ModalResult := mrOk;

    btnCancel := TButton.Create(ExportDialog);
    btnCancel.Parent := ExportDialog;
    btnCancel.Caption := 'Annuler';
    btnCancel.Left := 290;
    btnCancel.Top := 220;
    btnCancel.Width := 80;
    btnCancel.Cancel := True;
    btnCancel.ModalResult := mrCancel;

    // Afficher la boîte de dialogue
    if ExportDialog.ShowModal = mrOk then
    begin
      // Exporter selon les options choisies
      case cboPdfQuality.ItemIndex of
        0, 1, 2: ExportToPdf(cboPdfQuality.ItemIndex, chkIncludeCharts.Checked);
        3, 4: ExportToExcel(cboPdfQuality.ItemIndex - 3, chkIncludeCharts.Checked);
        5: ExportToWord(chkIncludeCharts.Checked);
      end;
    end;
  finally
    ExportDialog.Free;
  end;
end;
```

## Exercices pratiques

Pour mettre en pratique les concepts abordés dans cette section, voici quelques exercices :

1. **Rapport de rentabilité** : Créez un rapport qui analyse la rentabilité par produit, en calculant la marge brute et le taux de marge.

2. **Tableau de bord clients** : Développez un tableau de bord qui montre l'évolution du nombre de clients, leur fidélité (nombre de commandes par client) et la valeur client (montant moyen dépensé).

3. **Rapport de stocks critiques** : Créez un rapport qui identifie les produits dont le stock est inférieur au seuil minimal, avec des alertes visuelles.

4. **Analyse des produits les plus vendus** : Développez un graphique interactif permettant de visualiser les produits les plus vendus par catégorie et période.

5. **Export automatisé de rapports** : Implémentez une fonctionnalité qui génère et envoie automatiquement par email des rapports hebdomadaires aux responsables.

## Conseils pour des rapports efficaces

1. **Simplicité avant tout** : Privilégiez la clarté et la simplicité plutôt que des graphiques complexes ou surchargés.

2. **Contexte et comparaisons** : Incluez toujours des points de référence (période précédente, objectifs) pour donner du contexte aux chiffres.

3. **Cohérence visuelle** : Utilisez une charte graphique cohérente (couleurs, polices, styles) pour tous vos rapports.

4. **Focus sur l'action** : Assurez-vous que chaque rapport ou tableau de bord conduit à des actions concrètes.

5. **Retours utilisateurs** : Sollicitez régulièrement l'avis des utilisateurs pour améliorer vos rapports.

## Conclusion

Les rapports et tableaux de bord sont essentiels pour transformer vos données brutes en informations exploitables. Grâce à Delphi et ses composants, vous pouvez créer des outils d'analyse puissants et personnalisés qui aideront votre entreprise à prendre des décisions éclairées.

Dans cette section, vous avez appris à utiliser FastReport pour créer des rapports statiques, TeeChart pour développer des visualisations graphiques, et à implémenter des tableaux de bord interactifs. Vous avez également découvert comment personnaliser l'expérience utilisateur et optimiser les performances de vos rapports.

En intégrant ces fonctionnalités à votre application de gestion MySQL/MariaDB, vous offrez une valeur ajoutée significative à vos utilisateurs et transformez votre logiciel en un véritable outil d'aide à la décision.

Dans la prochaine section, nous ferons la synthèse de tout ce que nous avons appris pour finaliser notre application de gestion complète et préparer son déploiement.

---

*Note : Les exemples de code présentés dans cette section peuvent nécessiter des ajustements selon votre environnement spécifique et la structure exacte de votre base de données.*
